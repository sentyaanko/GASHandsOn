# System-Weapon
HeroCharacter が装備可能な武器のアクターを作成し、実際に HeroCharacter に装備できるようにし、装備時にアビリティを付与するようにする。

※このドキュメントは書きかけです。

# 方法

大まかには以下の通り。

* このバージョンではライフルだけを追加する。
* ロケットランチャーとショットガンについては共通部分のみ追加する。
* 一人称視点 / 三人称視点の対応は保留。
	* フリーカメラの状態なので、銃口の向きと射撃の方向が合致していない等。
* 武器のモデルに関しても暫定で ICO 球 で代用する。

# 手順

## ソース類

1. `GASHandsOn.Build.cs`
	* `Paper2D` モジュールの追加
		* TargetReticle 用。
		* 他のものに差し替える可能性あり。
1. `GHOHUDReticle.cpp` / `GHOHUDReticle.h` の新規作成
	* TargetReticle 用。
1. `GHOHUDWidget.cpp` / `GHOHUDWidget.h`
	* 武器用のインターフェイス追加。
1. `GHOPlayerController.cpp` / `GHOPlayerController.h`
	* 武器用の HUD 制御用インターフェイス追加。
1. `GHOGATA_Trace.cpp` / `GHOGATA_Trace.h` / `GHOGATA_LineTrace.cpp` / `GHOGATA_LineTrace.h` / `GHOGATA_SphereTrace.cpp` / `GHOGATA_SphereTrace.h` の新規作成
	* 武器用の GameplayAbility TargetActor の追加。
1. `GHOAttributeSetAmmo.cpp` / `GHOAttributeSetAmmo.h` の新規作成
	* 弾倉用の AttributeSet 。
1. `GHOPlayerState.cpp` / `GHOPlayerState.h`
	* Ammo 用 AttributeSet の追加。
1. `GHOWeapon.cpp` / `GHOWeapon.h` の新規作成
	* 武器用の Actor 。
1. `GHOHeroCharacterBase.cpp` / `GHOHeroCharacterBase.h`
	* インベントリの追加。
	* 装備中の武器追加。
1. `GHOAbilityTask_WaitDelayOneFrame.cpp` / `GHOAbilityTask_WaitDelayOneFrame.h`
	* 1 フレーム待つ `AbilityTask` 。
	* リロードなどのモンタージュ再生中に銃を撃った場合等に備え、モンタージュが止まるのを待つのに使用。
1. `GHOAbilityTask_ServerWaitForClientTargetData.cpp` / `GHOAbilityTask_ServerWaitForClientTargetData.h`
	* Authority は TargetData を待つようにし、そうでない場合は何もしない `AbilityTask` 。
	* 使い方としては、 `Local Predicted` な `GameplayAbility` で呼び出す
		* サーバーは TargetData のレプリケーションを待つ
		* クライアントはそのまま処理を継続し、ユーザーの入力に従い TargetData を作成し、サーバーにレプリケーションする
1. `GHOAbilityTask_WaitTargetDataUsingActor.cpp` / `GHOAbilityTask_WaitTargetDataUsingActor.h`
	* `TargetActor` を流用する拡張を行った、 `UAbilityTask_WaitTargetData` の独自拡張。
1. `GHOTargetTypes.cpp` / `GHOTargetTypes.h`
	* 主に `GameplayEffect` を適用するターゲットを扱うためのクラスを定義している。
	* `UGHOTargetType` は `FGHOGameplayEffectContainer::TargetType` で保持される。
	* `FGHOGameplayEffectContainer` は `UGHOGameplayAbility::EffectContainerMap` で保持される。
	* つまり、 `UGHOGameplayAbility` 内で、 `GameplayEffect` を特定のターゲットを適用するためのクラスとして使用されている。
1. `GHOGameplayEffectTypes.cpp` / `GHOGameplayEffectTypes.h`
	* 主に `GameplayEffect` を適用するターゲットを `GameplayAbility` のブループリント内で静的に指定するためのクラスを定義している。
	* 前述の `GHOTargetTypes` を参照。
1. `GHOBlueprintFunctionLibrary.cpp` / `GHOBlueprintFunctionLibrary.h`
	* 指定された `AbilitySystemComponent` と `GameplayAbility` の情報から、適用された `GameplayAbility` のインスタンスを取得するユーティリティ関数の追加。
	* ブループリントに公開されていない、ハンドルの Valid 判定を行うユーティリティ関数の追加。
	* ブループリントに公開していない、 `FGHOGameplayEffectContainerSpec` のメンバ関数にアクセスするユーティリティ関数の追加。
		* `FGHOGameplayEffectContainerSpec` が構造体で、 `UFUNCTION` の使用ができないため、ブループリントファンクションライブラリを経由している。
1. `GHOAbilitySystemComponent.cpp` / `GHOAbilitySystemComponent.h`
	* `AbilitySystemComponent` の静的関数として、 `Actor` が保持している `AbilitySystemComponent` の派生クラスのインスタンスを取得するユーティリティ関数の追加。
	* 基底の `AbilitySystemComponent` に用意されている、サーバーと同期しないルーズな `GameplayTag` を操作する関数をブループリントに公開するために追加。
		* 武器変更時のモンタージュで他の操作を受け付けない期間を、サーバーと同期せずにクライアント単体で `GameplayTag` を利用して実現するために使用。
			* 期間は `AnimNotifyState` でこの関数を呼ぶことで指定。
	* `AbilitySystemComponent` で保持されている、指定された `GameplayAbility` のインスタンスハンドルを返す関数の追加。
		* ある `GameplayAbility` から他の `GameplayAbility` のインスタンスを探す際に利用する。
	* `RPC` のバッチ呼び出しをする関数の追加。
		* 詳細はヘッダファイルのコメント参照。
1. `GHOGameplayAbility.cpp` / `GHOGameplayAbility.h`
	* コストのチェック・適用方法をブループリントで指定できるようにするための仕組みの追加。
		* 武器に装填された弾丸の制御で必要（ `AttributeSet` で管理されないため）。
	* アビリティを停止させるための関数（ private ）を呼び出す関数を、 public で追加。
		* `RPC` のバッチ呼び出しの際に使用。
	* ブループリントに公開されていない `GetSourceObject` を公開。
	* `GameplayAbility` 内に、適用していない `GameplayEffect` を保持しておき、後で適用できる仕組みの追加。
		* TODO: `GameplayEffect` のインスタンス流用？
	* アビリティの発動時に、そのアビリティを付与した武器をまだ装備しているときだけ発動できるようにする仕組みの追加。
1. `GHOWeapon.cpp` / `GHOWeapon.h`
	* 武器のアクター。詳細はコード参照。
1. 複数の `USkeletalMeshComponents` を持つ `AvatarActor` に `AnimMontage` を適用する拡張
	* 以下のファイルが該当するが、使用していないのでコードを無効化している。
	1. `GHOAbilityTask_PlayMontageForMeshAndWaitForEvent.cpp` / `GHOAbilityTask_PlayMontageForMeshAndWaitForEvent.h`
		* メッシュを指定して `AnimMontage` を適用し、終了を待つ `AbilityTask` 。
	1. `GHOGameplayAbility.cpp` / `GHOGameplayAbility.h`
		* 関連する関数はだいたい名前に `ForMesh` 等がついている。
	1. `GHOAbilitySystemComponent.cpp` / `GHOAbilitySystemComponent.h`
		* 関連する関数はだいたい名前に `ForMesh` 等がついている。
1. `GHOAbilityTask_WaitChangeFOV.cpp` / `GHOAbilityTask_WaitChangeFOV.h`
	* FOV の変更を待つ `AbilityTask` の追加。
		* Rifle のセカンダリアビリティで使用。


## リソース

* `A_Bullet_Impact_Body.sfs` / `.wav` / `.uasset` / `_Cue.uasset`
	* 銃弾が Character に命中した際に再生する音素材。
* `A_Bullet_Impact_Object.lch` / `.wav` / `.uasset` / `_Cue.uasset`
	* 銃弾が Character 以外に命中した際に再生する音素材。
* `A_Rifle_Shoot.sfs` / `.wav` / `.uasset` / `_Cue.uasset`
	* ライフルの発砲音の音素材。


## ブループリント

1. リロードモーション用
	1. `ANS_AddLooseGameplayTags`
		* 指定期間、ルーズな `GameplayTag` を適用するための `AnimNotifyState` 。
	1. `A_RifleEquip`
		* ライフルの装備モーション。
	1. `AM_Hero_RifleEquip`
		* ライフルの装備モーションに、 `ANS_AddLooseGameplayTags` で `Ability.Weapon.IsChanging` を適用しているアニメーションモンタージュ。
1. パーティクル用
	1. `M_RadialGradient`
		* 放射状のグラデーションになっている、パーティクル用マテリアル。
	1. `PS_Bullet_Impact_Body`
		* 銃弾が Character に命中した際に再生するパーティクル。
	1. `PS_Bullet_Impact_Object`
		* 銃弾が Character 以外に命中した際に再生するパーティクル。
	1. `PS_Rifle_MuzzleFlash`
		* ライフルの発砲時の銃口の火花のパーティクル。
	1. `PS_Rifle_Trail`
		* ライフルの発砲時の射線の軌跡用のパーティクル。
1. ライフルモデル用
	1. `Rifle_Skelton`/ `SK_Rifle` / `M_Rifle` / `T_Rifle_D`
		* スケルトン / スケルタルメッシュ / マテリアル / ディフューズテクスチャ
1. ショットガンモデル用
	1. `Shotgun_Skelton`/ `SK_Shotgun` / `M_Shotgun` / `T_Shotgun_D`
		* スケルトン / スケルタルメッシュ / マテリアル / ディフューズテクスチャ
1. ロケットランチャーモデル用
	1. `Launcher_Skelton`/ `SK_Launcher` / `M_Launcher` / `T_Launcher_D`
		* スケルトン / スケルタルメッシュ / マテリアル / ディフューズテクスチャ
1. ライフルアビリティ用
	1. Actor 用ブループリント
		1. `BP_Rifle`
			* `GHOWeapon` 派生。
			* 詳細はグラフ参照。
	1. `GameplayEffect`
		1. `GE_RifleAiming`
			* Rifle の ADS を実行している `GameplayTag` を付与する `GameplayEffect`
		1. `GE_RifleAimingRemoval`
			* Rifle の ADS をやめたことを示す `GameplayTag` を付与する `GameplayEffect`
		1. `GE_RifleDamage`
			* Rifle のダメージ計算用の `GameplayEffect`
		1. `GE_RifleReload`
			* Rifle のリロード用の `GameplayEffect`
			* 所持している銃弾数は PlayerState の AmmoAttributeSet に保存しており、その値を `GameplayTag` `Data.ReloadAmount.Reserve` だけ減らす。
	1. `GameplayAbility`
		1. `GA_RiflePrimary` / `GA_RiflePrimaryInstant`
			* Rifle の左クリック用アビリティ。詳細はグラフのコメント参照。
		1. `GA_RifleSecondary`
			* Rifle の右クリック用アビリティ。詳細はグラフのコメント参照。
		1. `GA_RifleReload`
			* Rifle のリロード用アビリティ。詳細はグラフのコメント参照。
	1. `GameplayCue`
		1. `GC_Weapon_Rifle_Fire`
			* `GameplayCue.Weapon.Rifle.Fire` 用（ライフルの発砲用）の `GameplayCue` 。
	1. その他
		1. `BP_Rifle_RireCameraShake`
			* 発砲時のカメラシェイク
		1. `AM_Hero_RifleReload`
			* Rifle のリロード用モンタージュ。
1. `BP_HeroCharacterBase`
	* `GASDocumentation` で作成したマウスに割り当てているアビリティを外す。
		* `GA_AimDonwSights_HeroBase` / `GA_FireGun` / `GA_Meteor_HeroBase`
	* `WeaponAttachPoint` に `WeaponPoint` を指定。
	* `CapsuleComponent` のコリジョン設定を変更（詳しくはグラフ参照）
	* `CameraBoom` / `FollowCamera` の位置を銃弾が多少見やすいように調整。
1. `BP_DefaultHero`
	* 基底（ `BP_HeroCharacterBase` ）の更新により更新がかかっているが変更なし。
1. `GE_HeroAttributes`
	* `GHOAttributeSetAmmo.MaxRifleReserveAmmo` / `GHOAttributeSetAmmo.RifleReserveAmmo` の初期値設定。
1. `GA_InteactPassive`
	* デバッグ描画が on になっていたので無効化。
1. `GA_Dash`
	* `GameplayTag` の設定。
1. `BP_Pickup_Health`
	* `Pickup` のコリジョン設定。
1. `SK_Mannequin` / `SK_Mannequin_Skelton`
	* 骨 `head` の下にソケット `WeaponPoint` の追加。


## エンジン - Input

* `PrimaryFire`
	* Weapon の左クリックアビリティ用。
* `SecondaryFire`
	* Weapon の右クリックアビリティ用。
* `AlternateFire`
	* Weapon の中央クリックアビリティ用。
* `NextWeapon`
	* Weapon 正順変更用アビリティ用。
* `PrevWeapon`
	* Weapon 逆順変更用アビリティ用。
* `Reload`
	* Weapon 逆順変更用アビリティ用。
* `Ability1` / `Ability2` / `Ability3` / `Ability5`
	* `GASDocumentation` で作成したアビリティ用。
	* `Ability1` / `Ability2` / `Ability5` は Weapon の割当とかぶってしまうので `NumPad1` / `NumPad2` / `NumPad5` に割当変更。
	* `Ability3` は無関係だが、ついでに  `NumPad3` に割当変更。

## エンジン - Collision

### Object Channels

| 名前           | デフォルト応答    |
|----------------|-------------------|
| `Ability`      | Block (ブロック)  |
| `Projectile`   | Block (ブロック)  |
| `Pickup`       | Block (ブロック)  |

* `Ability` / `Projectile` の設定変更
	* GASDocument で追加していたものを変更する。（デフォルト応答を オーバーラップ -> ブロック に変更）
	* 今回の機能追加で関連があるのは `Projectile` だが、ついでに `Ability` も同様に変更しておく。
* `Pickup` の新規追加
	* 以前作成したヘルス回復のピックアップ用。
	* `Hero` のコリジョン設定が色々変わるので、ついでにここも変えておく。


### Preset

|                    |                                             |
|--------------------|---------------------------------------------|
| 名前               | `Projectile`                                |
| コリジョン Enable  | Query Only (No Physics Collision)           |
| オブジェクトタイプ | Projectile                                  |
| 説明               | Overlaps Pawns and AbilityOverlapProjectile |

| コリジョンレスポンス | 無視する | オーバーラップ | ブロック |
|----------------------|----------|----------------|----------|
| トレース型           |          |                |          |
| Visibility           | ✔       |                |          |
| Camera               | ✔       |                |          |
|                      |          |                |          |
| オブジェクト型       |          |                |          |
| WorldStatic          |          |                | ✔       |
| WorldDynamic         |          |                | ✔       |
| Pawn                 |          | ✔             |          |
| PhysicsBody          |          |                | ✔       |
| Vehicle              |          |                | ✔       |
| Destructable         |          |                | ✔       |
| Ability              | ✔       |                |          |
| Projectile           | ✔       |                |          |
| Interactable         | ✔       |                |          |
| Projectile           | ✔       |                |          |

* `TargetActorGroundLocation` / `InteractTrace`
	* `Pickup` を `無視する` にする。




## GameplayTag の追加

| タグ名                                      | 用途                                                                                                                                |
----------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| `Ability.Weapon`                            | 武器用のアビリティ用のルート。                                                                                                      |
| `Ability.Weapon.Primary`                    | 左クリックした際に発火する武器のアビリティ用タグ。                                                                                  |
| `Ability.Weapon.Primary.Instant`            | 左クリックをトリガとするアビリティ内で BatchRPCTryActivateAbility() に渡す、 RPC のバッチ処理が行われるアビリティ用タグ。           |
| `Ability.Weapon.Secondary`                  | 右クリックした際に発火する武器のアビリティ用タグ。                                                                                  |
| `Ability.Weapon.Secondary.Instant`          | 未使用。右クリックをトリガとするアビリティ内で BatchRPCTryActivateAbility() に渡す、 RPC のバッチ処理が行われるアビリティ用タグ。   |
| `Ability.Weapon.Alternate`                  | 中央クリックした際に発火する武器のアビリティ用タグ。                                                                                |
| `Ability.Weapon.Alternate.Instant`          | 未使用。中央クリックをトリガとするアビリティ内で BatchRPCTryActivateAbility() に渡す、 RPC のバッチ処理が行われるアビリティ用タグ。 |
| `Ability.Weapon.Reload`                     | BP でのみ使用。                                                                                                                     |
| `Ability.Weapon.IsChanging`                 | 武器変更モーション中を示す。                                                                                                        |
| `Ability.Weapon.IsChangingDelayReplication` | 武器を変更した際に 1.5 秒だけ設定される。 連続した武器変更をサーバーとスムーズに同期するためのタグ。                                |
| `Ability.CancelsSprint`                     | スプリントアビリティを他のアビリティからキャンセルするためタグ。                                                                    |
| `Data.ReloadAmount.Reserve`                 | リロード時、手持ちの弾薬のアトリビュートを減らす量を GameplayEffect の Modifier に渡すためのタグ。                                  |
| `Effect.Damage.CanHeadShot`                 | ダメージ計算時、ヘッドショット判定を行うかを示すタグ。                                                                              |
| `Effect.Damage.HeadShot`                    | ダメージ計算結果、ヘッドショットだったことを示すタグ。                                                                              |
| `GameplayCue.Weapon.Rifle.Fire`             | ライフル発砲時の Cue 用タグ。                                                                                                       |
| `GameplayCue.Weapon.RocketLauncher.Fire`    | ロケットランチャー発砲時の Cue 用タグ。                                                                                             |
| `GameplayCue.Weapon.RocketLauncher.Impact`  | ロケットランチャー着弾時の Cue 用タグ。                                                                                             |
| `GameplayCue.Weapon.Shotgun.Fire`           | ショットガン発砲時の Cue 用タグ。                                                                                                   |
| `Weapon.Ammo.None`                          | 無効な弾薬種別を表すタグ。                                                                                                          |
| `Weapon.Ammo.Rifle`                         | ライフルの弾薬種別を表すタグ。                                                                                                      |
| `Weapon.Ammo.Rocket`                        | ロケットランチャーの弾薬種別を表すタグ。                                                                                            |
| `Weapon.Ammo.Shotgun`                       | ショットガンの弾薬種別を表すタグ。                                                                                                  |
| `Weapon.Equipped.None`                      | 無効な武器種別を表すタグ。                                                                                                          |
| `Weapon.Equipped.Rifle`                     | ライフルの武器種別を表すタグ。                                                                                                      |
| `Weapon.Equipped.RocketLauncher`            | ロケットランチャーの武器種別を表すタグ。                                                                                            |
| `Weapon.Equipped.Shotgun`                   | ショットガンの武器種別を表すタグ。                                                                                                  |
| `Weapon.Fail.Activation.OnCooldown`         | ユーザーの入力が武器の発砲可能間隔より早かった場合に `CanActivateAbility` で失敗を返す際に渡すタグ。                                |
| `Weapon.FireMode.None`                      | 無効な武器の射撃モード。武器の射撃モードがない場合に利用する。                                                                      |
| `Weapon.IsFiring`                           | 射撃中を示すタグ。射撃中に縦断の同期を行わなくするのに利用する。                                                                    |
| `Weapon.Rifle.Aiming`                       | エイムしているのを示すタグ。                                                                                                        |
| `Weapon.Rifle.Aiming.Removal`               | エイムを予測的にやめるためのタグ。                                                                                                  |
| `Weapon.Rifle.FireMode.Burst`               | 発砲モード：バースト用。                                                                                                            |
| `Weapon.Rifle.FireMode.FullAuto`            | 発砲モード：フルオート用。                                                                                                          |
| `Weapon.Rifle.FireMode.SemiAuto`            | 発砲モード：セミオート用。                                                                                                          |
| `Weapon.RocketLauncher.Aiming`              | エイムしているのを示すタグ。                                                                                                        |
| `Weapon.RocketLauncher.Aiming.Removal`      | エイムを予測的にやめるためのタグ。                                                                                                  |
| `Weapon.Shotgun.Aiming`                     | エイムしているのを示すタグ。                                                                                                        |
| `Weapon.Shotgun.Aiming.Removal`             | エイムを予測的にやめるためのタグ。                                                                                                  |
| `Weapon.Shotgun.FireMode.FullAuto`          | 発砲モード：フルオート用。                                                                                                          |
| `Weapon.Shotgun.FireMode.SemiAuto`          | 発砲モード：セミオート用。                                                                                                          |

TODO: 用途書くよ。

* `Ability.Weapon`
	* 装備解除時にすべての武器のアビリティをキャンセルするときに使用。
		* `AGHOHeroCharacterBase::SetCurrentWeapon()` 内で `AbilitySystemComponent->CancelAbilities()` の引数で指定している。
	* 武器変更アビリティ中に他の武器アビリティの有効化を阻害するのに使用。
		* 武器変更アビリティ `GA_NextWeapon` / `GA_PreviousWeapon` の `Block Abilities with Tag` で指定。
		* ***ただし、武器変更は GAS の外で行われており、モンタージュの再生と同期していない（アビリティの ActivateAbility は同一フレームで EndAbility を呼び出す）。詳細は `GA_NextWeapon` / `GA_PreviousWeapon` のコメント参照。***
* `Ability.Weapon.Primary`
	* 左クリックアビリティ用のタグ。
		* 左クリックアビリティの `Ability Tags` で指定。
		* リロードアビリティが有効化する際に左クリックアビリティがキャンセルさせるのに使用。
			* リロードアビリティの `Cancel Abilities with Tag` で指定。
		* 右クリックアビリティ中に左クリックアビリティの有効化を阻害させるのに使用。
			* ロケットランチャーの右クリックアビリティの `Block Abilities with Tag` で指定。
* `Ability.Weapon.Secondary`
	* 武器の右クリック時のアビリティ用のタグ。
		* 武器の右クリックアビリティの `Ability Tags` で指定。
* `Ability.Weapon.Alternate`
	* 武器の中央クリック時のアビリティ用のタグ。
		* 武器の中央クリックアビリティの `Ability Tags` で指定。
		* ロケットランチャーには何も割り当てられていないので該当の GameplayAbility が存在しない。
* `Ability.Weapon.Primary.Instant` / `Ability.Weapon.Secondary.Instant` / `Ability.Weapon.Alternate.Instant` 共通
	* C++ 内では `AGHOHeroCharacterBase` でキャッシュを保持しているが利用はしていない模様。
* `Ability.Weapon.Secondary.Instant` / `Ability.Weapon.Alternate.Instant` 共通
	* 利用するアビリティが存在しないので使用していない。
* `Ability.Weapon.Primary.Instant`
	* 左クリック時のアビリティ内で RPC をバッチ処理するために用意された GameplayAbility 用のタグ。
		* 具体的には銃弾の処理。
		* RPC のバッチ処理については [4.6.15 Ability Batching](https://github.com/sentyaanko/GASDocumentation/blob/lang-ja/README.md#4615-ability-batching) [（和訳）](https://github.com/sentyaanko/GASDocumentation/blob/lang-ja/README.jp.md#4615-ability-batching-ability-%E3%81%AE%E3%83%90%E3%83%83%E3%83%81%E5%87%A6%E7%90%86) も参照。
* `Ability.Weapon.Reload`
	* GA_RiflePrimary
		* 左クリックアビリティが有効化する際にリロードアビリティがキャンセルさせるのに使用。
			* `Cancel Abilities with Tag` で指定。
		* 残弾がない場合にリロードアビリティを呼び出すため `Try ActivateAbilities by Tag` の引数に指定
	* GA_RifleReload
		* `Ability Tags` で指定。
* `Ability.Weapon.IsChanging`
	* 武器変更アビリティ `GA_NextWeapon` / `GA_PreviousWeapon` の `Ability Tags` で指定。
	* 左クリックアビリティ中に武器変更アビリティの有効化を阻害させるのに使用。
		* 左クリックアビリティの `Block Abilities with Tag` で指定。
	* 武器のアビリティ / 武器変更アビリティは武器変更のモンタージュの特定の区間内では武器変更アビリティを有効化できなくするのに使用。
		* 武器のアビリティ / 武器変更アビリティの `Activation Blocked Tags` で指定。
		* モンタージュで武器変更モーションの間、 AnimNotifyState を使用して `AddLooseGameplayTags` / `RemoveLooseGameplayTags` を呼び出し、ローカルで GameplayTag を付与している。
			* 付与しているのはここだけ。したがって、このタグはローカルにしか付与されない。
		* ***武器変更アビリティは Next / Previous の二種類があるため、同時に起動しないように抑制が必要。***
			* ***前述の通り起動直後にアビリティが終了するので一瞬のみ（同一フレーム対策になるかどうか程度の意味しかない）。***
		* ***武器変更アビリティ中の武器のアビリティの抑制は、ここまでの説明のように二重で行われている。***
			1. ***`GA_NextWeapon` / `GA_PreviousWeapon` の `Block Abilities with Tag` で `Ability.Weapon` を指定することで、武器変更アビリティが有効な間は武器のアビリティを抑制。***
				* ***前述の通り起動直後にアビリティが終了するので一瞬のみ（同一フレーム対策になるかどうか程度の意味しかない）。***
			1. ***武器のアビリティの `Activation Blocked Tags` で `Ability.Weapon.IsChanging` を指定することで、武器変更のモンタージュの特定の期間内は武器アビリティを有効化できないようにしている。***
				* ***ローカルに付与されるタグを利用し、ローカルでのみ判定することで設定した期間だけすぐに応答し有効化できないようにしている。***
	* なんらかのアビリティの有効化に失敗した際、武器変更中かを判断するのに C++ で使用。
		* `AGHOHeroCharacter::OnAbilityActivationFailed()` にて指定。
* `Ability.Weapon.IsChangingDelayReplication`
	* 武器を変更して 1.5 秒経ってから AutonomousProxy が能動的に `CurrentWeapon` の更新処理を行うようにする仕組みで利用。
		* `GE_WeaponIsChangingDelayReplicationTag` で 1.5 秒のみ付与している。
			* 武器変更アビリティ `GA_NextWeapon` / `GA_PreviousWeapon` で上記の GameplayEffect を付与している。
		* `AGHOHeroCharacterBase` 内で、このタグが変更された際のコールバックが登録されている。
			* コールバック内では、タグの削除時に `CurrentWeapon` の更新処理が呼ばれるようになっている。
			* 詳しくは `AGHOHeroCharacterBase::WeaponChangingDelayReplicationTagChanged()` のコメント参照。
* `Ability.CancelsSprint`
	* ***TOD:すでに `Ability.Sprint.Cancel` として存在するので実装を確認した上でこの項目を削除すること。***
	* スプリントアビリティを（他のアビリティの有効化により）終了するためのタグ。
		* `GA_Sprint` 内で `Wait Gameplay Tag Add` を使用してこのタグが付与されるのを監視し、付与されたら `EndAbility` を呼び出している。
	* 武器のアビリティが有効化する際にスプリントアビリティを終了するのに使用。
		* `GA_RiflePrimary` / `GA_RifleSecondary` / `GA_RocketLauncherPrimary` / `GA_RocketLauncherSecondary` / `GA_ShotgunPrimary` / `GA_ShotgunSecondary` の `Activation Owned Tags` で指定。
* `Data.ReloadAmount.Reserve`
	* リロード時、手持ちの弾薬のアトリビュートを減らす量を GameplayAbility で値を設定し、 GameplayEffect の Modifier に渡すためのタグ。
	* 武器の装填数を増やすのは GameplayAbility で `AGHOWeapon::SetPrimaryClipAmmo()` を呼び出して行っている（ AttributeSet ではなく、 Actor のメンバで保持）。
	* 仕組みについて、詳しくは [4.4.2.3.1 Plain Floats on the Item](https://github.com/sentyaanko/GASDocumentation/blob/lang-ja/README.md#44231-plain-floats-on-the-item) [（和訳）](https://github.com/sentyaanko/GASDocumentation/blob/lang-ja/README.jp.md#44231-%E3%82%A2%E3%82%A4%E3%83%86%E3%83%A0%E6%AF%8E%E3%81%AE%E5%8D%98%E7%B4%94%E3%81%AA-float-%E5%80%A4) を参照。
* `Effect.Damage.CanHeadShot`
	* ダメージ計算時、ヘッドショット判定を行うかを示すタグ。
	* ヘッドショット判定を行うライフル/ショットガンのダメージ用 GameplayEffect `GE_RifleDamage` / `GE_ShotgunDamage` で渡し、`UGHODamageExecutionCalc` 内で参照。
* `Effect.Damage.HeadShot`
	* ダメージ計算結果、ヘッドショットだったことを示すタグ。
	* C++ のみで利用。
	* `UGHODamageExecutionCalc` で設定して `UGHOAttributeSetBase` で参照。
* `GameplayCue.Weapon.Rifle.Fire`
	* ライフル発砲時の Cue 用タグ。
* `GameplayCue.Weapon.RocketLauncher.Fire`
	* ロケットランチャー発砲時の Cue 用タグ。
* `GameplayCue.Weapon.RocketLauncher.Impact`
	* ロケットランチャー着弾時の Cue 用タグ。
* `GameplayCue.Weapon.Shotgun.Fire`
	* ショットガン発砲時の Cue 用タグ。
* `Weapon.Ammo.None`
	* 無効な弾薬種別を表すタグ。
	* `AGHOWeapon` の `PrimaryAmmoType` / `SecondaryAmmoType` の初期値、 `AGHOHeroCharacterBase::AddWeaponToInventory()` の中などで利用。
* `Weapon.Ammo.Rifle` / `Weapon.Ammo.Rocket` / `Weapon.Ammo.Shotgun` 共通
	* アトリビュートセットから各弾薬種別の所持数を取得する際に利用。
		* `UGHOAmmoAttributeSet` の `GetReserveAmmoAttributeFromTag()` / `GetMaxReserveAmmoAttributeFromTag()` の中で利用。
* `Weapon.Ammo.Rifle`
	* ライフルの弾薬種別を表すタグ。
	* `BP_Rifle` の `PrimaryAmmoType` で指定。
* `Weapon.Ammo.Rocket`
	* ロケットランチャーの弾薬種別を表すタグ。
	* `BP_RocketLauncher` の `PrimaryAmmoType` で指定。
* `Weapon.Ammo.Shotgun`
	* ショットガンの弾薬種別を表すタグ。
	* `BP_Shotgun` の `PrimaryAmmoType` で指定。
* `Weapon.Equipped.None`
	* 無効な武器種別を表すタグ。
	* `AGHOHeroCharacterBase::CurrentWeaponTag` の初期値、 `AGHOHeroCharacterBase::UnEquipCurrentWeapon()` の中などで利用。
* `Weapon.Equipped.Rifle` / `Weapon.Equipped.RocketLauncher` / `Weapon.Equipped.Shotgun` 共通
	* 一人称視点用のキャラクターのアニメーションブループリントで武器ごとのモーションを使用するために利用。
		* `ABP_Hero1P` で利用。
			* モーション的にはライフルとショットガンで同じものを使っているため、 `Weapon.Equipped.Shotgun` は使用していない。
* `Weapon.Equipped.Rifle`
	* ライフルの武器種別を表すタグ。
		* `BP_Rifle` の `Weapon Tag` で指定。
* `Weapon.Equipped.RocketLauncher`
	* ロケットランチャーの武器種別を表すタグ。
		* `BP_RocketLauncher` の `Weapon Tag` で指定。
* `Weapon.Equipped.Shotgun`
	* ショットガンの武器種別を表すタグ。
		* `BP_Shotgun` の `Weapon Tag` で指定。
* `Weapon.Fail.Activation.OnCooldown`
	* ユーザーの入力が武器の発砲可能間隔より早かった場合に `CanActivateAbility` で失敗を返す際に渡すタグ。
		* 失敗した場合は `AGHOHeroCharacter::OnAbilityActivationFailed()` に渡される。
		* ***が、このタグを利用していない。不要？***
* `Weapon.FireMode.None`
	* 無効な武器の射撃モード。武器の射撃モードがない場合に利用する。
	* `BP_RocketLauncher` の `DefaultFireMode` で利用。
	* ***各武器ごとの FireMode にも言えるが、ブループリント内で完結しており、 C++ では参照していない。***
* `Weapon.Rifle.FireMode.Burst` /  `Weapon.Rifle.FireMode.FullAuto` / `Weapon.Rifle.FireMode.SemiAuto` / `Weapon.Shotgun.FireMode.FullAuto` / `Weapon.Shotgun.FireMode.SemiAuto` 共通
	* `AGHOWeapon` の `FireMode` に保存。
* `Weapon.IsFiring`
	* 射撃中を示すタグ。射撃中に銃弾の同期を行わなくするのに利用する。
	* 仕組みについて、詳しくは [4.4.2.3.1 Plain Floats on the Item](https://github.com/sentyaanko/GASDocumentation/blob/lang-ja/README.md#44231-plain-floats-on-the-item) [（和訳）](https://github.com/sentyaanko/GASDocumentation/blob/lang-ja/README.jp.md#44231-%E3%82%A2%E3%82%A4%E3%83%86%E3%83%A0%E6%AF%8E%E3%81%AE%E5%8D%98%E7%B4%94%E3%81%AA-float-%E5%80%A4) を参照。
* `Weapon.Rifle.*` / `Weapon.RocketLauncher.*` / `Weapon.Shotgun.*`
	* ***ブループリント内で完結している。***
* `Weapon.Rifle.Aiming` / `Weapon.Rifle.Aiming.Removal`
	* エイムしている / 予測的にやめるのを示すタグ。
	* エイムをしているかどうかを判定するのに使用。
	* `GE_RifleAiming` / `GE_RifleAimingRemoval` の `GrantedTags` で指定。
* `Weapon.Rifle.FireMode.Burst` /  `Weapon.Rifle.FireMode.FullAuto` / `Weapon.Rifle.FireMode.SemiAuto`
	* 発砲モード：バースト用 / フルオート用 /セミオート用。
	* `GA_RifleAlternate` で射撃モードを変更する際に使用。
	* `GA_RiflePrimary` で射撃の処理の際、現在の射撃モードを判定するために使用。
* `Weapon.RocketLauncher.Aiming` / `Weapon.RocketLauncher.Aiming.Removal`
	* エイムしている / 予測的にやめるのを示すタグ。
	* エイムをしているかどうかを判定するのに使用。
	* `GE_RocketLauncherAiming` / `GE_RocketLauncherAimingRemoval` の `GrantedTags` で指定。
* `Weapon.Shotgun.Aiming` / `Weapon.Shotgun.Aiming.Removal`
	* エイムしている / 予測的にやめるのを示すタグ。
	* エイムをしているかどうかを判定するのに使用。
	* `GE_ShotgunAiming` / `GE_ShotgunAimingRemoval` の `GrantedTags` で指定。
* `Weapon.Shotgun.FireMode.FullAuto` / `Weapon.Shotgun.FireMode.SemiAuto`
	* 発砲モード：フルオート用 / セミオート用。
	* `GA_ShotgunAlternate` で射撃モードを変更する際に使用。
	* `GA_ShotgunPrimary` で射撃の処理の際、現在の射撃モードを判定するために使用。



rof = rate of fire

以上で、 HeroCharacter で武器を使用することができるようになります。

-----
# 補足

-----
## GASShooter の各 1PV Mesh で行っていること

* レプリケーション対象ではない。
	* 無理やり表示させない限り、自分が操作しているキャラクターのみしか表示されないので、レプリケーションする意味がない。
	* そのため、各処理の書き方次第で伝播する範囲が変わる。
* 発砲
	* 1PV Mesh にしかモンタージュが存在しない。
		* （そのため、他のクライアントからは射撃しているかどうかは発砲エフェクトを見ないとわからない。）
	* AutonomousProxy および Authority のみでの射撃モーションの再生している。
		* `GA_RiflePrimariyInstant` などでモーションを再生しているが、到達するのが上記2つのロールのみ。
* ADS
	* 1PV Mesh にしかモンタージュが存在しない。
		* （そのため、他のクライアントからは ADS しているかどうかはわからない。）
	* モンタージュの適用は `ABP_Hero1P` 内で `Weapon.Rifle.Aiming` などの状況により設定される。
		* （そのため、全端末に適用される可能性がある。）
* リロード
	* 1PV/3PV Mesh 両方のモンタージュを再生しているが、前者はレプリケーションしていない。
		* `GA_RifleReload` の `Play Montage for Mesh and Wait for Event` の `Replicate Montage` に `false` / `true` をそれぞれ指定している。
	* そのため、基本的には 1PV は AutonomousProxy および Authority のみで再生される。
		* `GA_RifleReload` の `Net Execution Policy` が `Local Predicated` の為。
	* 但し、 ADS 中にリロードを行うと SimulatedProxy でもモーションの再生が行われる。
		* 原因は、 ADS /リロードのどちらも FullBody スロットを使っているせいだと思われるが、詳細は確認していないので不明。

-----
## 各 GameplayAbility について

* `Net Execution Policy` について
	* `Local Only`
		* Primary / Alternate
	* `Local Predicated`
		* Secondary
		* PrimaryInstant
		* Reload

-----
## リロード処理の流れ

* GameplayAbility 内の処理
	* リロード用のモンタージュの再生を行う。その際、 `Ability.Weapon.Reload` イベントを監視する。
		* モンタージュ内で AnimNotify を使用して `Ability.Weapon.Reload` イベントが発生するようにしている。
		* 上記イベントが発生したら Ammo を補充する。
* リロードアビリティと左クリックアビリティ
	* 互いに `Cancel Abilities with Tags` で指定している。
	* そのため、一方のアビリティが発動中にもう一方が発動するとキャンセルがかかる。
	* 左クリックアビリティによるリロードアビリティのキャンセル
		* Ammo がある時はキャンセルがかかる。
		* Ammo が 0 の間は左クリックアビリティのコストチェックで失敗するので、左クリックアビリティが発動せずキャンセルがかからない。
		* リロードアビリティ処理の中で Ammo が補充されるが、その時点で左クリックアビリティのコストチェックが成功し左クリックアビリティが発動するようになる。
			* つまりは Ammo が 0 の時に発動したリロードアビリティは途中までキャンセルがかからず、途中からキャンセルがかかるようになっている。
* リロードキー入力時
	* アビリティにキーを割り当てることでキー入力時にリロードアビリティを発動している。
* 左クリック時
	* Ammo が 0 の場合、左クリックアビリティのコストチェックの際、失敗を返す前にリロードアビリティを発動している。
		* `Try Activate Abilities by Tag` で `Ability.Weapon.Reload` を指定して発動している。
		* Ammo が補充される前の２回目以降の呼び出しは（アビリティが既に発動しているので） `Try Activate Abilities by Tag` が失敗する。
	* Ammo が補充されると「左クリックアビリティのコストチェック」が成功するようになり、左クリック時のアビリティが発動する。
		* その結果、リロードアビリティはキャンセルがかかり、 `Play Montage for Mesh and Wait for Event` でモンタージュの再生の完了を待たず `On Cancelled` が呼び出さされ、そこで `CancelAbility` を実行している。
* このようにして、
	* リロードアビリティの発動を行い（リロードキー入力による発動、又は左クリックアビリティのコストチェックの際にコスト不足ならリロードアビリティの発動）、 
	* Ammo が 0 の間は左クリックアビリティの発動を抑制し（コストチェックで false を返すことでアビリティの発動を抑制）、 
	* （リロードアビリティの多重発動抑制は特にしていない（もともと同一の GameplayAbility を多重に発動できないので、 `Try Activate Abilities by Tag` が失敗を返すのに任せている））
	* リロードアビリティの途中で Ammo を補充し（モンタージュ再生時にイベントの発生を監視し、イベント発生時に Ammo を補充）、
	* Ammo が補充された時点で左クリックアビリティの発動が可能となり（コストチェックで true を返せるようになるのでアビリティの発動が可能）、
	* 左クリックアビリティの発動時にリロードアビリティをキャンセルするようになっている（キャンセルタグの指定によるリロードアビリティのキャンセル、モンタージュ再生タスクの中断、およびアビリティのキャンセル）。


-----
## AGHOHeroCharacterBase::EquipWeapon() について

* 関数単体で、 Net Role 毎に以下のような処理を行う。
	* `Authority` では
		* `SetCurrentWeapon()` を呼び出すことにより `CurrentWeapon` の owner の設定等を行う。
	* `Authority` 以外では
		* `RPCServerEquipWeapon()` を呼び出し、サーバー側で `RPCServerEquipWeapon_Implementation()` -> `EquipWeapon()` を呼び出すようにする。 
		* `SetCurrentWeapon()` を呼び出すことにより `CurrentWeapon` の owner の設定等を行う。
		* `bChangedWeaponLocally` を立ててローカル予測状態であることをわかるようにする。
* ただし、実際にこの関数は `Authority` / `AutonomousProxy` でしか呼び出されない。
	* 呼び出し元は以下の四箇所。
		1. `AddWeaponToInventory()`
			* `SpawnDefaultInventory()` から呼び出される。
				* この関数の先頭で ```if (GetLocalRole() < ROLE_Authority){return;}``` しているため、 ***`AddWeaponToInventory()` は `Authority` からのみ呼び出される***。
		1. `NextWeapon()` / `PreviousWeapon()`
			* `GA_NextWeapon` / `GA_PreviousWeapon`
				* この `GameplayAbility` の `Net Execution Policy` は `Local Predicted` であり、 `Ability Input ID` で割り当てられたキー入力を元に起動される。
				* そのため、挙動としては、 [4.6.4 Activating Abilities](https://github.com/sentyaanko/GASDocumentation/blob/lang-ja/README.md#464-activating-abilities) [（和訳）](https://github.com/sentyaanko/GASDocumentation/blob/lang-ja/README.jp.md#464-activating-abilities-abilities-%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96) にある `locally predicted （ローカル予測） された GameplayAbilities の有効化シーケンス` のような流れとなる。
				* 端的に言えば ***`AutonomousProxy` / `Authority` の両方から呼び出され、 `SimulatedProxy` からは呼び出されない***。
		1. `ServerEquipWeapon_Implementation()`
			* `EquipWeapon()`
				* この関数の ```if (GetLocalRole() < ROLE_Authority)``` で括られた箇所からの呼び出しのため、 `Authority` 以外からのみ呼び出される。
	* `ServerEquipWeapon()` 自体が `EquipWeapon()` からのみ呼び出されるため、実質的には `AddWeaponToInventory()` / `NextWeapon()` / `PreviousWeapon()` が呼び出し元となる。
* `ServerEquipWeapon()` の呼び出しについて
	* 不要と思われる。以下はその理由。
		* `ServerEquipWeapon()` は、 `Authority` で `EquipWeapon()` を呼び出すための関数。
		* `AddWeaponToInventory()` はそもそも `Authority` で呼び出されるため、無関係。
		* `NextWeapon()` / `PreviousWeapon()` は `AutonomousProxy` / `Authority` の両方から呼び出されるため、ことさら `EquipWeapon()` 内で `ServerEquipWeapon()` を呼び出さなくても `Authority` 側でも `NextWeapon()` / `PreviousWeapon()` 経由で `EquipWeapon()` が呼び出される。
	* よって、`GASHandsOn` では `ServerEquipWeapon()` の呼び出しをコメントアウトしています。

-----
## CurrentWeapon の同期の流れ

### AutonomousProxy での CurrentWeapon の初期化
#### Case1 PlayerState -> Inventory の順にレプリケーションされた場合
![CurrentWeapon-Initialize-AutonomousProxy-Case1](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/sentyaanko/GASHandsOn/feature/Add-Weapon-System/Documents/0.1.7/CurrentWeapon-Initialize-AutonomousProxy-Case1.puml)

#### Case2 Inventory -> PlayerState の順にレプリケーションされた（ RPC のほうが早かった）場合
![CurrentWeapon-Initialize-AutonomousProxy-Case2](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/sentyaanko/GASHandsOn/feature/Add-Weapon-System/Documents/0.1.7/CurrentWeapon-Initialize-AutonomousProxy-Case2.puml)

### SimulatedProxy での CurrentWeapon の初期化
#### Case1 PlayerState -> CurrentWeapon の順にレプリケーションされた場合
![CurrentWeapon-Initialize-SimulatedProxy-Case1](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/sentyaanko/GASHandsOn/feature/Add-Weapon-System/Documents/0.1.7/CurrentWeapon-Initialize-SimulatedProxy-Case1.puml)

#### Case2 CurrentWeapon -> PlayerState の順にレプリケーションされた場合
![CurrentWeapon-Initialize-SimulatedProxy-Case2](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/sentyaanko/GASHandsOn/feature/Add-Weapon-System/Documents/0.1.7/CurrentWeapon-Initialize-SimulatedProxy-Case2.puml)

#### CurrentWeapon の変更
![CurrentWeapon-Change](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/sentyaanko/GASHandsOn/feature/Add-Weapon-System/Documents/0.1.7/CurrentWeapon-Change.puml)

#### CurrentWeapon の同期、 AutonomousProxy で MissPrediction した際
![CurrentWeapon-Sync-AutonomousProxy-MissPrediction](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/sentyaanko/GASHandsOn/feature/Add-Weapon-System/Documents/0.1.7/CurrentWeapon-Sync-AutonomousProxy-MissPrediction.puml)

-----
おしまい。

