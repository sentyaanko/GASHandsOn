# System-Weapon
HeroCharacter が装備可能な武器のアクターを作成し、実際に HeroCharacter に装備できるようにし、装備時にアビリティを付与するようにする。

※このドキュメントは書きかけです。

# 方法

大まかには以下の通り。


# 手順

## ソース類

1. `GASHandsOn.Build.cs`
	* `Paper2D` モジュールの追加
		* TargetReticle 用。
		* 他のものに差し替える可能性あり。
1. `GHOHUDReticle.cpp` / `GHOHUDReticle.h` の新規作成
	* TargetReticle 用。
1. `GHOHUDWidget.cpp` / `GHOHUDWidget.h`
	* 武器用のインターフェイス追加。
1. `GHOPlayerController.cpp` / `GHOPlayerController.h`
	* 武器用の HUD 制御用インターフェイス追加。
1. `GHOGATA_Trace.cpp` / `GHOGATA_Trace.h` / `GHOGATA_LineTrace.cpp` / `GHOGATA_LineTrace.h` / `GHOGATA_SphereTrace.cpp` / `GHOGATA_SphereTrace.h` の新規作成
	* 武器用の GameplayAbility TargetActor の追加。
1. `GHOAttributeSetAmmo.cpp` / `GHOAttributeSetAmmo.h` の新規作成
	* 弾倉用の AttributeSet 。
1. `GHOPlayerState.cpp` / `GHOPlayerState.h`
	* Ammo 用 AttributeSet の追加。
1. `GHOWeapon.cpp` / `GHOWeapon.h` の新規作成
	* 武器用の Actor 。
1. `GHOHeroCharacterBase.cpp` / `GHOHeroCharacterBase.h`
	* インベントリの追加。
	* 装備中の武器追加。


## GameplayTag の追加

| タグ名                                      | 用途                                                                                                                                |
----------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| `Ability.Weapon`                            | 武器用のアビリティ用のルート。                                                                                                      |
| `Ability.Weapon.Primary`                    | 左クリックした際に発火する武器のアビリティ用タグ。                                                                                  |
| `Ability.Weapon.Primary.Instant`            | 左クリックをトリガとするアビリティ内で BatchRPCTryActivateAbility() に渡す、 RPC のバッチ処理が行われるアビリティ用タグ。           |
| `Ability.Weapon.Secondary`                  | 右クリックした際に発火する武器のアビリティ用タグ。                                                                                  |
| `Ability.Weapon.Secondary.Instant`          | 未使用。右クリックをトリガとするアビリティ内で BatchRPCTryActivateAbility() に渡す、 RPC のバッチ処理が行われるアビリティ用タグ。   |
| `Ability.Weapon.Alternate`                  | 中央クリックした際に発火する武器のアビリティ用タグ。                                                                                |
| `Ability.Weapon.Alternate.Instant`          | 未使用。中央クリックをトリガとするアビリティ内で BatchRPCTryActivateAbility() に渡す、 RPC のバッチ処理が行われるアビリティ用タグ。 |
| `Ability.Weapon.Reload`                     | BP でのみ使用。                                                                                                                     |
| `Ability.Weapon.IsChanging`                 | 武器変更モーション中を示す。                                                                                                        |
| `Ability.Weapon.IsChangingDelayReplication` | 武器を変更した際に 1.5 秒だけ設定される。 連続した武器変更をサーバーとスムーズに同期するためのタグ。                                |
| `Ability.CancelsSprint`                     | スプリントアビリティを他のアビリティからキャンセルするためタグ。                                                                    |
| `Data.ReloadAmount.Reserve`                 | リロード時、手持ちの弾薬のアトリビュートを減らす量を GameplayEffect の Modifier に渡すためのタグ。                                  |
| `Effect.Damage.CanHeadShot`                 | ダメージ計算時、ヘッドショット判定を行うかを示すタグ。                                                                              |
| `Effect.Damage.HeadShot`                    | ダメージ計算結果、ヘッドショットだったことを示すタグ。                                                                              |
| `GameplayCue.Weapon.Rifle.Fire`             | ライフル発砲時の Cue 用タグ。                                                                                                       |
| `GameplayCue.Weapon.RocketLauncher.Fire`    | ロケットランチャー発砲時の Cue 用タグ。                                                                                             |
| `GameplayCue.Weapon.RocketLauncher.Impact`  | ロケットランチャー着弾時の Cue 用タグ。                                                                                             |
| `GameplayCue.Weapon.Shotgun.Fire`           | ショットガン発砲時の Cue 用タグ。                                                                                                   |
| `Weapon.Ammo.None`                          | 無効な弾薬種別を表すタグ。                                                                                                          |
| `Weapon.Ammo.Rifle`                         | ライフルの弾薬種別を表すタグ。                                                                                                      |
| `Weapon.Ammo.Rocket`                        | ロケットランチャーの弾薬種別を表すタグ。                                                                                            |
| `Weapon.Ammo.Shotgun`                       | ショットガンの弾薬種別を表すタグ。                                                                                                  |
| `Weapon.Equipped.None`                      | 無効な武器種別を表すタグ。                                                                                                          |
| `Weapon.Equipped.Rifle`                     | ライフルの武器種別を表すタグ。                                                                                                      |
| `Weapon.Equipped.RocketLauncher`            | ロケットランチャーの武器種別を表すタグ。                                                                                            |
| `Weapon.Equipped.Shotgun`                   | ショットガンの武器種別を表すタグ。                                                                                                  |
| `Weapon.Fail.Activation.OnCooldown`         | ユーザーの入力が武器の発砲可能間隔より早かった場合に `CanActivateAbility` で失敗を返す際に渡すタグ。                                |
| `Weapon.FireMode.None`                      | 無効な武器の射撃モード。武器の射撃モードがない場合に利用する。                                                                      |
| `Weapon.IsFiring`                           | 射撃中を示すタグ。射撃中に縦断の同期を行わなくするのに利用する。                                                                    |
| `Weapon.Rifle.Aiming`                       | エイムしているのを示すタグ。                                                                                                        |
| `Weapon.Rifle.Aiming.Removal`               | エイムを予測的にやめるためのタグ。                                                                                                  |
| `Weapon.Rifle.FireMode.Burst`               | 発砲モード：バースト用。                                                                                                            |
| `Weapon.Rifle.FireMode.FullAuto`            | 発砲モード：フルオート用。                                                                                                          |
| `Weapon.Rifle.FireMode.SemiAuto`            | 発砲モード：セミオート用。                                                                                                          |
| `Weapon.RocketLauncher.Aiming`              | エイムしているのを示すタグ。                                                                                                        |
| `Weapon.RocketLauncher.Aiming.Removal`      | エイムを予測的にやめるためのタグ。                                                                                                  |
| `Weapon.Shotgun.Aiming`                     | エイムしているのを示すタグ。                                                                                                        |
| `Weapon.Shotgun.Aiming.Removal`             | エイムを予測的にやめるためのタグ。                                                                                                  |
| `Weapon.Shotgun.FireMode.FullAuto`          | 発砲モード：フルオート用。                                                                                                          |
| `Weapon.Shotgun.FireMode.SemiAuto`          | 発砲モード：セミオート用。                                                                                                          |

TODO: 用途書くよ。

* `Ability.Weapon`
	* 装備解除時にすべての武器のアビリティをキャンセルするときに使用。
		* `AGHOHeroCharacterBase::SetCurrentWeapon()` 内で `AbilitySystemComponent->CancelAbilities()` の引数で指定している。
	* 武器変更アビリティ中に他の武器アビリティの有効化を阻害するのに使用。
		* 武器変更アビリティ `GA_NextWeapon` / `GA_PreviousWeapon` の `Block Abilities with Tag` で指定。
		* ***ただし、武器変更は GAS の外で行われており、モンタージュの再生と同期していない（アビリティの ActivateAbility は同一フレームで EndAbility を呼び出す）。詳細は `GA_NextWeapon` / `GA_PreviousWeapon` のコメント参照。***
* `Ability.Weapon.Primary`
	* 左クリックアビリティ用のタグ。
		* 左クリックアビリティの `Ability Tags` で指定。
		* リロードアビリティが有効化する際に左クリックアビリティがキャンセルさせるのに使用。
			* リロードアビリティの `Cancel Abilities with Tag` で指定。
		* 右クリックアビリティ中に左クリックアビリティの有効化を阻害させるのに使用。
			* ロケットランチャーの右クリックアビリティの `Block Abilities with Tag` で指定。
			* ただし、まだ未実装。
* `Ability.Weapon.Secondary`
	* 武器の右クリック時のアビリティ用のタグ。
		* 武器の右クリックアビリティの `Ability Tags` で指定。
* `Ability.Weapon.Alternate`
	* 武器の中央クリック時のアビリティ用のタグ。
		* 武器の中央クリックアビリティの `Ability Tags` で指定。
		* ロケットランチャーには何も割り当てられていないので該当の GameplayAbility が存在しない。
* `Ability.Weapon.Primary.Instant` / `Ability.Weapon.Secondary.Instant` / `Ability.Weapon.Alternate.Instant` 共通
	* C++ 内では `AGHOHeroCharacterBase` でキャッシュを保持しているが利用はしていない模様。
* `Ability.Weapon.Secondary.Instant` / `Ability.Weapon.Alternate.Instant` 共通
	* 利用するアビリティが存在しないので使用していない。
* `Ability.Weapon.Primary.Instant`
	* 左クリック時のアビリティ内で RPC をバッチ処理するために用意された GameplayAbility 用のタグ。
		* 具体的には銃弾の処理。
		* RPC のバッチ処理については [4.6.15 Ability Batching](https://github.com/sentyaanko/GASDocumentation/blob/lang-ja/README.md#4615-ability-batching) [（和訳）](https://github.com/sentyaanko/GASDocumentation/blob/lang-ja/README.jp.md#4615-ability-batching-ability-%E3%81%AE%E3%83%90%E3%83%83%E3%83%81%E5%87%A6%E7%90%86) も参照。
* `Ability.Weapon.Reload`
	* GA_RiflePrimary
		* 左クリックアビリティが有効化する際にリロードアビリティがキャンセルさせるのに使用。
			* `Cancel Abilities with Tag` で指定。
		* 残弾がない場合にリロードアビリティを呼び出すため `Try ActivateAbilities by Tag` の引数に指定
	* GA_RifleReload
		* `Ability Tags` で指定。
* `Ability.Weapon.IsChanging`
	* 武器変更アビリティ `GA_NextWeapon` / `GA_PreviousWeapon` の `Ability Tags` で指定。
	* 左クリックアビリティ中に武器変更アビリティの有効化を阻害させるのに使用。
		* 左クリックアビリティの `Block Abilities with Tag` で指定。
	* 武器のアビリティ / 武器変更アビリティは武器変更のモンタージュの特定の区間内では武器変更アビリティを有効化できなくするのに使用。
		* 武器のアビリティ / 武器変更アビリティの `Activation Blocked Tags` で指定。
		* モンタージュで武器変更モーションの間、 AnimNotifyState を使用して `AddLooseGameplayTags` / `RemoveLooseGameplayTags` を呼び出し、ローカルで GameplayTag を付与している。
			* 付与しているのはここだけ。したがって、このタグはローカルにしか付与されない。
		* ***武器変更アビリティは Next / Previous の二種類があるため、同時に起動しないように抑制が必要。***
			* ***前述の通り起動直後にアビリティが終了するので一瞬のみ（同一フレーム対策になるかどうか程度の意味しかない）。***
		* ***武器変更アビリティ中の武器のアビリティの抑制は、ここまでの説明のように二重で行われている。***
			1. ***`GA_NextWeapon` / `GA_PreviousWeapon` の `Block Abilities with Tag` で `Ability.Weapon` を指定することで、武器変更アビリティが有効な間は武器のアビリティを抑制。***
				* ***前述の通り起動直後にアビリティが終了するので一瞬のみ（同一フレーム対策になるかどうか程度の意味しかない）。***
			1. ***武器のアビリティの `Activation Blocked Tags` で `Ability.Weapon.IsChanging` を指定することで、武器変更のモンタージュの特定の期間内は武器アビリティを有効化できないようにしている。***
				* ***ローカルに付与されるタグを利用し、ローカルでのみ判定することで設定した期間だけすぐに応答し有効化できないようにしている。***
	* なんらかのアビリティの有効化に失敗した際、武器変更中かを判断するのに C++ で使用。
		* `AGHOHeroCharacter::OnAbilityActivationFailed()` にて指定。
* `Ability.Weapon.IsChangingDelayReplication`
	* 武器を変更して 1.5 秒経ってから AutonomousProxy が能動的に `CurrentWeapon` の更新処理を行うようにする仕組みで利用。
		* `GE_WeaponIsChangingDelayReplicationTag` で 1.5 秒のみ付与している。
			* 武器変更アビリティ `GA_NextWeapon` / `GA_PreviousWeapon` で上記の GameplayEffect を付与している。
		* `AGHOHeroCharacterBase` 内で、このタグが変更された際のコールバックが登録されている。
			* コールバック内では、タグの削除時に `CurrentWeapon` の更新処理が呼ばれるようになっている。
			* 詳しくは `AGHOHeroCharacterBase::WeaponChangingDelayReplicationTagChanged()` のコメント参照。
* `Ability.CancelsSprint`
	* スプリントアビリティを（他のアビリティの有効化により）終了するためのタグ。
		* `GA_Sprint` 内で `Wait Gameplay Tag Add` を使用してこのタグが付与されるのを監視し、付与されたら `EndAbility` を呼び出している。
	* 武器のアビリティが有効化する際にスプリントアビリティを終了するのに使用。
		* `GA_RiflePrimary` / `GA_RifleSecondary` / `GA_RocketLauncherPrimary` / `GA_RocketLauncherSecondary` / `GA_ShotgunPrimary` / `GA_ShotgunSecondary` の `Activation Owned Tags` で指定。
* `Data.ReloadAmount.Reserve`
	* リロード時、手持ちの弾薬のアトリビュートを減らす量を GameplayAbility で値を設定し、 GameplayEffect の Modifier に渡すためのタグ。
	* 武器の装填数を増やすのは GameplayAbility で `AGHOWeapon::SetPrimaryClipAmmo()` を呼び出して行っている（ AttributeSet ではなく、 Actor のメンバで保持）。
* `Effect.Damage.CanHeadShot`
	* ダメージ計算時、ヘッドショット判定を行うかを示すタグ。
	* ヘッドショット判定を行うライフル/ショットガンのダメージ用 GameplayEffect `GE_RifleDamage` / `GE_ShotgunDamage` で渡し、`UGHODamageExecutionCalc` 内で参照。
* `Effect.Damage.HeadShot`
	* ダメージ計算結果、ヘッドショットだったことを示すタグ。
	* C++ のみで利用。
	* `UGHODamageExecutionCalc` で設定して `UGHOAttributeSetBase` で参照。
* `GameplayCue.Weapon.Rifle.Fire`
	* ライフル発砲時の Cue 用タグ。
* `GameplayCue.Weapon.RocketLauncher.Fire`
	* ロケットランチャー発砲時の Cue 用タグ。
* `GameplayCue.Weapon.RocketLauncher.Impact`
	* ロケットランチャー着弾時の Cue 用タグ。
* `GameplayCue.Weapon.Shotgun.Fire`
	* ショットガン発砲時の Cue 用タグ。
* `Weapon.Ammo.None`
	* 無効な弾薬種別を表すタグ。
	* `AGHOWeapon` の `PrimaryAmmoType` / `SecondaryAmmoType` の初期値、 `AGHOHeroCharacterBase::AddWeaponToInventory()` の中などで利用。
* `Weapon.Ammo.Rifle` / `Weapon.Ammo.Rocket` / `Weapon.Ammo.Shotgun` 共通
	* アトリビュートセットから各弾薬種別の所持数を取得する際に利用。
		* `UGHOAmmoAttributeSet` の `GetReserveAmmoAttributeFromTag()` / `GetMaxReserveAmmoAttributeFromTag()` の中で利用。
* `Weapon.Ammo.Rifle`
	* ライフルの弾薬種別を表すタグ。
	* `BP_Rifle` の `PrimaryAmmoType` で指定。
* `Weapon.Ammo.Rocket`
	* ロケットランチャーの弾薬種別を表すタグ。
	* `BP_RocketLauncher` の `PrimaryAmmoType` で指定。
* `Weapon.Ammo.Shotgun`
	* ショットガンの弾薬種別を表すタグ。
	* `BP_Shotgun` の `PrimaryAmmoType` で指定。
* `Weapon.Equipped.None`
	* 無効な武器種別を表すタグ。
	* `AGHOHeroCharacterBase::CurrentWeaponTag` の初期値、 `AGHOHeroCharacterBase::UnEquipCurrentWeapon()` の中などで利用。
* `Weapon.Equipped.Rifle` / `Weapon.Equipped.RocketLauncher` / `Weapon.Equipped.Shotgun` 共通
	* 一人称視点用のキャラクターのアニメーションブループリントで武器ごとのモーションを使用するために利用。
		* `ABP_Hero1P` で利用。
			* モーション的にはライフルとショットガンで同じものを使っているため、 `Weapon.Equipped.Shotgun` は使用していない。
* `Weapon.Equipped.Rifle`
	* ライフルの武器種別を表すタグ。
		* `BP_Rifle` の `Weapon Tag` で指定。
* `Weapon.Equipped.RocketLauncher`
	* ロケットランチャーの武器種別を表すタグ。
		* `BP_RocketLauncher` の `Weapon Tag` で指定。
* `Weapon.Equipped.Shotgun`
	* ショットガンの武器種別を表すタグ。
		* `BP_Shotgun` の `Weapon Tag` で指定。
* `Weapon.Fail.Activation.OnCooldown`
	* ユーザーの入力が武器の発砲可能間隔より早かった場合に `CanActivateAbility` で失敗を返す際に渡すタグ。
		* 失敗した場合は `AGHOHeroCharacter::OnAbilityActivationFailed()` に渡される。
		* ***が、このタグを利用していない。不要？***
* `Weapon.FireMode.None`
	* 無効な武器の射撃モード。武器の射撃モードがない場合に利用する。
	* `BP_RocketLauncher` の `DefaultFireMode` で利用。
	* ***各武器ごとの FireMode にも言えるが、ブループリント内で完結しており、 C++ では参照していない。***
* `Weapon.Rifle.FireMode.Burst` /  `Weapon.Rifle.FireMode.FullAuto` / `Weapon.Rifle.FireMode.SemiAuto` / `Weapon.Shotgun.FireMode.FullAuto` / `Weapon.Shotgun.FireMode.SemiAuto` 共通
	* `AGHOWeapon` の `FireMode` に保存。
* `Weapon.IsFiring`
	* 射撃中を示すタグ。射撃中に銃弾の同期を行わなくするのに利用する。
	* 仕組みについて、詳しくは [4.4.2.3.1 Plain Floats on the Item](https://github.com/sentyaanko/GASDocumentation/blob/lang-ja/README.md#44231-plain-floats-on-the-item) [（和訳）](https://github.com/sentyaanko/GASDocumentation/blob/lang-ja/README.jp.md#44231-%E3%82%A2%E3%82%A4%E3%83%86%E3%83%A0%E6%AF%8E%E3%81%AE%E5%8D%98%E7%B4%94%E3%81%AA-float-%E5%80%A4) を参照。
* `Weapon.Rifle.*` / `Weapon.RocketLauncher.*` / `Weapon.Shotgun.*`
	* ***ブループリント内で完結している。***
* `Weapon.Rifle.Aiming` / `Weapon.Rifle.Aiming.Removal`
	* エイムしている / 予測的にやめるのを示すタグ。
	* エイムをしているかどうかを判定するのに使用。
	* `GE_RifleAiming` / `GE_RifleAimingRemoval` の `GrantedTags` で指定。
* `Weapon.Rifle.FireMode.Burst` /  `Weapon.Rifle.FireMode.FullAuto` / `Weapon.Rifle.FireMode.SemiAuto`
	* 発砲モード：バースト用 / フルオート用 /セミオート用。
	* `GA_RifleAlternate` で射撃モードを変更する際に使用。
	* `GA_RiflePrimary` で射撃の処理の際、現在の射撃モードを判定するために使用。
* `Weapon.RocketLauncher.Aiming` / `Weapon.RocketLauncher.Aiming.Removal`
	* エイムしている / 予測的にやめるのを示すタグ。
	* エイムをしているかどうかを判定するのに使用。
	* `GE_RocketLauncherAiming` / `GE_RocketLauncherAimingRemoval` の `GrantedTags` で指定。
* `Weapon.Shotgun.Aiming` / `Weapon.Shotgun.Aiming.Removal`
	* エイムしている / 予測的にやめるのを示すタグ。
	* エイムをしているかどうかを判定するのに使用。
	* `GE_ShotgunAiming` / `GE_ShotgunAimingRemoval` の `GrantedTags` で指定。
* `Weapon.Shotgun.FireMode.FullAuto` / `Weapon.Shotgun.FireMode.SemiAuto`
	* 発砲モード：フルオート用 / セミオート用。
	* `GA_ShotgunAlternate` で射撃モードを変更する際に使用。
	* `GA_ShotgunPrimary` で射撃の処理の際、現在の射撃モードを判定するために使用。



rof = rate of fire

以上で、 HeroCharacter で武器を使用することができるようになります。

-----
# 補足

-----
## 各 GameplayAbility について

* `Net Execution Policy` について
	* `Local Only`
		* Primary / Alternate
	* `Local Predicated`
		* Secondary
		* PrimaryInstant
		* Reload

-----
## リロード処理の流れ

* GameplayAbility 内の処理
	* リロード用のモンタージュの再生を行う。その際、 `Ability.Weapon.Reload` イベントを監視する。
		* モンタージュ内で AnimNotify を使用して `Ability.Weapon.Reload` イベントが発生するようにしている。
		* 上記イベントが発生したら Ammo を補充する。
* リロードアビリティと左クリックアビリティ
	* 互いに `Cancel Abilities with Tags` で指定している。
	* そのため、一方のアビリティが発動中にもう一方が発動するとキャンセルがかかる。
	* 左クリックアビリティによるリロードアビリティのキャンセル
		* Ammo がある時はキャンセルがかかる。
		* Ammo が 0 の間は左クリックアビリティのコストチェックで失敗するので、左クリックアビリティが発動せずキャンセルがかからない。
		* リロードアビリティ処理の中で Ammo が補充されるが、その時点で左クリックアビリティのコストチェックが成功し左クリックアビリティが発動するようになる。
			* つまりは Ammo が 0 の時に発動したリロードアビリティは途中までキャンセルがかからず、途中からキャンセルがかかるようになっている。
* リロードキー入力時
	* アビリティにキーを割り当てることでキー入力時にリロードアビリティを発動している。
* 左クリック時
	* Ammo が 0 の場合、左クリックアビリティのコストチェックの際、失敗を返す前にリロードアビリティを発動している。
		* `Try Activate Abilities by Tag` で `Ability.Weapon.Reload` を指定して発動している。
		* Ammo が補充される前の２回目以降の呼び出しは（アビリティが既に発動しているので） `Try Activate Abilities by Tag` が失敗する。
	* Ammo が補充されると「左クリックアビリティのコストチェック」が成功するようになり、左クリック時のアビリティが発動する。
		* その結果、リロードアビリティはキャンセルがかかり、 `Play Montage for Mesh and Wait for Event` でモンタージュの再生の完了を待たず `On Cancelled` が呼び出さされ、そこで `CancelAbility` を実行している。
* このようにして、
	* リロードアビリティの発動を行い（リロードキー入力による発動、又は左クリックアビリティのコストチェックの際にコスト不足ならリロードアビリティの発動）、 
	* Ammo が 0 の間は左クリックアビリティの発動を抑制し（コストチェックで false を返すことでアビリティの発動を抑制）、 
	* （リロードアビリティの多重発動抑制は特にしていない（もともと同一の GameplayAbility を多重に発動できないので、 `Try Activate Abilities by Tag` が失敗を返すのに任せている））
	* リロードアビリティの途中で Ammo を補充し（モンタージュ再生時にイベントの発生を監視し、イベント発生時に Ammo を補充）、
	* Ammo が補充された時点で左クリックアビリティの発動が可能となり（コストチェックで true を返せるようになるのでアビリティの発動が可能）、
	* 左クリックアビリティの発動時にリロードアビリティをキャンセルするようになっている（キャンセルタグの指定によるリロードアビリティのキャンセル、モンタージュ再生タスクの中断、およびアビリティのキャンセル）。


-----
## AGHOHeroCharacterBase::EquipWeapon() について

* 関数単体で、 Net Role 毎に以下のような処理を行う。
	* `Authority` では
		* `SetCurrentWeapon()` を呼び出すことにより `CurrentWeapon` の owner の設定等を行う。
	* `Authority` 以外では
		* `RPCServerEquipWeapon()` を呼び出し、サーバー側で `RPCServerEquipWeapon_Implementation()` -> `EquipWeapon()` を呼び出すようにする。 
		* `SetCurrentWeapon()` を呼び出すことにより `CurrentWeapon` の owner の設定等を行う。
		* `bChangedWeaponLocally` を立ててローカル予測状態であることをわかるようにする。
* ただし、実際にこの関数は `Authority` / `AutonomousProxy` でしか呼び出されない。
	* 呼び出し元は以下の四箇所。
		1. `AddWeaponToInventory()`
			* `SpawnDefaultInventory()` から呼び出される。
				* この関数の先頭で ```if (GetLocalRole() < ROLE_Authority){return;}``` しているため、 ***`AddWeaponToInventory()` は `Authority` からのみ呼び出される***。
		1. `NextWeapon()` / `PreviousWeapon()`
			* `GA_NextWeapon` / `GA_PreviousWeapon`
				* この `GameplayAbility` の `Net Execution Policy` は `Local Predicted` であり、 `Ability Input ID` で割り当てられたキー入力を元に起動される。
				* そのため、挙動としては、 [4.6.4 Activating Abilities](https://github.com/sentyaanko/GASDocumentation/blob/lang-ja/README.md#464-activating-abilities) [（和訳）](https://github.com/sentyaanko/GASDocumentation/blob/lang-ja/README.jp.md#464-activating-abilities-abilities-%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96) にある `locally predicted （ローカル予測） された GameplayAbilities の有効化シーケンス` のような流れとなる。
				* 端的に言えば ***`AutonomousProxy` / `Authority` の両方から呼び出され、 `SimulatedProxy` からは呼び出されない***。
		1. `ServerEquipWeapon_Implementation()`
			* `EquipWeapon()`
				* この関数の ```if (GetLocalRole() < ROLE_Authority)``` で括られた箇所からの呼び出しのため、 `Authority` 以外からのみ呼び出される。
	* `ServerEquipWeapon()` 自体が `EquipWeapon()` からのみ呼び出されるため、実質的には `AddWeaponToInventory()` / `NextWeapon()` / `PreviousWeapon()` が呼び出し元となる。
* `ServerEquipWeapon()` の呼び出しについて
	* 不要と思われる。以下はその理由。
		* `ServerEquipWeapon()` は、 `Authority` で `EquipWeapon()` を呼び出すための関数。
		* `AddWeaponToInventory()` はそもそも `Authority` で呼び出されるため、無関係。
		* `NextWeapon()` / `PreviousWeapon()` は `AutonomousProxy` / `Authority` の両方から呼び出されるため、ことさら `EquipWeapon()` 内で `ServerEquipWeapon()` を呼び出さなくても `Authority` 側でも `NextWeapon()` / `PreviousWeapon()` 経由で `EquipWeapon()` が呼び出される。
	* よって、`GASHandsOn` では `ServerEquipWeapon()` の呼び出しをコメントアウトしています。

-----
## CurrentWeapon の同期の流れ

### AutonomousProxy での CurrentWeapon の初期化
#### Case1 PlayerState -> Inventory の順にレプリケーションされた場合
![CurrentWeapon-Initialize-AutonomousProxy-Case1](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/sentyaanko/GASHandsOn/feature/Add-Weapon-System/Documents/0.1.7/CurrentWeapon-Initialize-AutonomousProxy-Case1.puml)

#### Case2 Inventory -> PlayerState の順にレプリケーションされた（ RPC のほうが早かった）場合
![CurrentWeapon-Initialize-AutonomousProxy-Case2](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/sentyaanko/GASHandsOn/feature/Add-Weapon-System/Documents/0.1.7/CurrentWeapon-Initialize-AutonomousProxy-Case2.puml)

### SimulatedProxy での CurrentWeapon の初期化
#### Case1 PlayerState -> CurrentWeapon の順にレプリケーションされた場合
![CurrentWeapon-Initialize-SimulatedProxy-Case1](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/sentyaanko/GASHandsOn/feature/Add-Weapon-System/Documents/0.1.7/CurrentWeapon-Initialize-SimulatedProxy-Case1.puml)

#### Case2 CurrentWeapon -> PlayerState の順にレプリケーションされた場合
![CurrentWeapon-Initialize-SimulatedProxy-Case2](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/sentyaanko/GASHandsOn/feature/Add-Weapon-System/Documents/0.1.7/CurrentWeapon-Initialize-SimulatedProxy-Case2.puml)

#### CurrentWeapon の変更
![CurrentWeapon-Change](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/sentyaanko/GASHandsOn/feature/Add-Weapon-System/Documents/0.1.7/CurrentWeapon-Change.puml)

#### CurrentWeapon の同期、 AutonomousProxy で MissPrediction した際
![CurrentWeapon-Sync-AutonomousProxy-MissPrediction](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/sentyaanko/GASHandsOn/feature/Add-Weapon-System/Documents/0.1.7/CurrentWeapon-Sync-AutonomousProxy-MissPrediction.puml)

-----
おしまい。
