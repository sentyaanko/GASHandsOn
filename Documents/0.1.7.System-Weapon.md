# System-Weapon
HeroCharacter が装備可能な武器のアクターを作成し、実際に HeroCharacter に装備できるようにし、装備時にアビリティを付与するようにする。

# 方法

大まかには以下の通り。

* このバージョンではライフルだけを追加する。
* ロケットランチャーとショットガンについては共通部分のみ追加する。
* 一人称視点 / 三人称視点の対応は保留。
	* フリーカメラの状態なので、銃口の向きと射撃の方向が合致していない等。
* 武器のモデルに関しても暫定で ICO 球 で代用する。
* 下記コメント内で武器変更に関して言及しているが、武器が一種類しかないため未実装。

# 手順

## ソース類

1. `GASHandsOn.Build.cs`
	* `Paper2D` モジュールの追加
		* GASShooter では TargetReticle で利用していた。
		* GASHandsOn では使用していない。
1. `GHOHUDReticle.cpp` / `GHOHUDReticle.h` の新規作成
	* TargetReticle 用。
1. `GHOHUDWidget.cpp` / `GHOHUDWidget.h`
	* 武器用のインターフェイス追加。
1. `GHOPlayerController.cpp` / `GHOPlayerController.h`
	* 武器用の HUD 制御用インターフェイス追加。
1. `GHOGATA_Trace.cpp` / `GHOGATA_Trace.h` / `GHOGATA_LineTrace.cpp` / `GHOGATA_LineTrace.h` / `GHOGATA_SphereTrace.cpp` / `GHOGATA_SphereTrace.h` の新規作成
	* 武器用の GameplayAbility TargetActor の追加。
1. `GHOGEEC_Damage.cpp` / `GHOGEEC_Damage.h`
	* 命中箇所による HeadShot 判定の追加。
1. `GHOAttributeSetBase.cpp` / `GHOAttributeSetBase.h`
	* HeadShot 時の表示テキスト変更処理追加。
1. `GHOAttributeSetAmmo.cpp` / `GHOAttributeSetAmmo.h` の新規作成
	* 弾薬用の AttributeSet 。
1. `GHOPlayerState.cpp` / `GHOPlayerState.h`
	* `UGHOAttributeSetAmmo` の追加。
1. `GHOWeapon.cpp` / `GHOWeapon.h` の新規作成
	* 武器用の Actor 。
1. `GHOHeroCharacterBase.cpp` / `GHOHeroCharacterBase.h`
	* インベントリの追加。
	* 装備中の武器追加。
1. `GHOAbilityTask_WaitDelayOneFrame.cpp` / `GHOAbilityTask_WaitDelayOneFrame.h`
	* 1 フレーム待つ AbilityTask 。
	* リロードなどの AnimMontage 再生中に銃を撃った場合等に備え、 AnimMontage が止まるのを待つのに使用。
1. `GHOAbilityTask_ServerWaitForClientTargetData.cpp` / `GHOAbilityTask_ServerWaitForClientTargetData.h`
	* Authority は TargetData を待つようにし、そうでない場合は何もしない AbilityTask 。
	* 使い方としては、 `Local Predicted` な GameplayAbility で呼び出す
		* サーバーは TargetData のレプリケーションを待つ
		* クライアントはそのまま処理を継続し、ユーザーの入力に従い TargetData を作成し、サーバーにレプリケーションする
1. `GHOAbilityTask_WaitTargetDataUsingActor.cpp` / `GHOAbilityTask_WaitTargetDataUsingActor.h`
	* TargetActor を流用する拡張を行った、 `UAbilityTask_WaitTargetData` の独自拡張。
		* 事前に作成した TargetActor を何度も流用できるようにした拡張を行っている。
		* `GA_RiflePrimaryInstant` で使用。
1. `GHOTargetTypes.cpp` / `GHOTargetTypes.h`
	* 主に GameplayEffect を適用するターゲットを扱うためのクラスを定義している。
	* `UGHOTargetType` は `FGHOGameplayEffectContainer::TargetType` で保持される。
	* `FGHOGameplayEffectContainer` は `UGHOGameplayAbility::EffectContainerMap` で保持される。
	* つまり、 `UGHOGameplayAbility` 内で、 GameplayEffect を特定のターゲットに適用するための静的情報として使用されている。
1. `GHOGameplayEffectTypes.cpp` / `GHOGameplayEffectTypes.h`
	* 主に GameplayEffect を適用するターゲットを GameplayAbility のブループリント内で静的に指定するためのクラスを定義している。
	* 前述の `GHOTargetTypes` を参照。
1. `GHOBlueprintFunctionLibrary.cpp` / `GHOBlueprintFunctionLibrary.h`
	* 指定された AbilitySystemComponent と GameplayAbility の情報から、適用された GameplayAbility のインスタンスを取得するユーティリティ関数の追加。
	* ブループリントに公開されていない、ハンドルの Valid 判定を行うユーティリティ関数の追加。
	* ブループリントに公開していない、 `FGHOGameplayEffectContainerSpec` のメンバ関数にアクセスするユーティリティ関数の追加。
		* `FGHOGameplayEffectContainerSpec` が構造体で、 UFUNCTION の使用ができないため、ブループリントファンクションライブラリを経由している。
1. `GHOAbilitySystemComponent.cpp` / `GHOAbilitySystemComponent.h`
	* AbilitySystemComponent の静的関数として、 Actor が保持している AbilitySystemComponent の派生クラスのインスタンスを取得するユーティリティ関数の追加。
	* 基底の AbilitySystemComponent に用意されている、サーバーと同期しない Loose な GameplayTag を操作する関数をブループリントに公開するために追加。
		* 武器変更時の AnimMontage で定義している他の操作を受け付けない期間を、サーバーと同期せずにクライアント単体で GameplayTag を利用してアビリティの発動を抑制するために使用。
			* 期間は AnimNotifyState でこの関数を呼ぶことで指定。
	* AbilitySystemComponent で保持されている、指定された GameplayAbility のインスタンスハンドルを返す関数の追加。
		* ある GameplayAbility から他の GameplayAbility のインスタンスを探す際に利用する。
	* RPC のバッチ呼び出しをする関数の追加。
		* 詳細はヘッダファイルのコメント参照。
1. `GHOGameplayAbility.cpp` / `GHOGameplayAbility.h`
	* コストのチェック・適用方法をブループリントで指定できるようにするための仕組みの追加。
		* 武器に装填された弾丸の制御で必要（ AttributeSet で管理されないため）。
	* アビリティを停止させるための関数（ private ）を呼び出す関数を、 public で追加。
		* RPC のバッチ呼び出しの際に使用。
	* ブループリントに公開されていない `GetSourceObject` を公開。
	* GameplayAbility 内に、適用していない GameplayEffect を保持しておき、後で適用できる仕組みの追加。
	* アビリティの発動時に、そのアビリティを付与した武器をまだ装備しているときだけ発動できるようにする仕組みの追加。
1. `GHOWeapon.cpp` / `GHOWeapon.h`
	* 武器のアクター。詳細はコード参照。
1. 複数の `USkeletalMeshComponent` を持つ AvatarActor に AnimMontage を適用する拡張
	* 要は 1PV/3PV の 2 つのメッシュでそれぞれ AnimMontage を再生するための拡張。
	* 以下のファイルが該当するが、使用していないのでコードを無効化している。
	1. `GHOAbilityTask_PlayMontageForMeshAndWaitForEvent.cpp` / `GHOAbilityTask_PlayMontageForMeshAndWaitForEvent.h`
		* メッシュを指定して AnimMontage を適用し、終了を待つ AbilityTask 。
	1. `GHOGameplayAbility.cpp` / `GHOGameplayAbility.h`
		* 関連する関数はだいたい名前に `ForMesh` 等がついている。
	1. `GHOAbilitySystemComponent.cpp` / `GHOAbilitySystemComponent.h`
		* 関連する関数はだいたい名前に `ForMesh` 等がついている。
1. `GHOAbilityTask_WaitChangeFOV.cpp` / `GHOAbilityTask_WaitChangeFOV.h`
	* FOV の変更を待つ AbilityTask の追加。
		* Rifle のセカンダリアビリティで使用。


## リソース

* `A_Bullet_Impact_Body.sfs` / `.wav` / `.uasset` / `_Cue.uasset`
	* 銃弾が Character に命中した際に再生する音素材。
* `A_Bullet_Impact_Object.lch` / `.wav` / `.uasset` / `_Cue.uasset`
	* 銃弾が Character 以外に命中した際に再生する音素材。
* `A_Rifle_Shoot.sfs` / `.wav` / `.uasset` / `_Cue.uasset`
	* ライフルの発砲音の音素材。
* `Reticles.xcf` / `T_BulletReticle_D.png` / `.uasset`
	* ライフルのレティクル用絵素材。


## ブループリント

1. リロードモーション用
	1. `ANS_AddLooseGameplayTags`
		* 指定期間、 Loose な GameplayTag を適用するための AnimNotifyState 。
	1. `A_RifleEquip`
		* ライフルの装備モーション。
	1. `AM_Hero_RifleEquip`
		* ライフルの装備モーションに、 `ANS_AddLooseGameplayTags` で `Ability.Weapon.IsChanging` を適用している AnimMontage。
1. パーティクル用
	1. `M_RadialGradient`
		* 放射状のグラデーションになっている、パーティクル用マテリアル。
	1. `PS_Bullet_Impact_Body`
		* 銃弾が Character に命中した際に再生するパーティクル。
	1. `PS_Bullet_Impact_Object`
		* 銃弾が Character 以外に命中した際に再生するパーティクル。
	1. `PS_Rifle_MuzzleFlash`
		* ライフルの発砲時の銃口の火花のパーティクル。
	1. `PS_Rifle_Trail`
		* ライフルの発砲時の射線の軌跡用のパーティクル。
1. ライフルモデル用
	1. `Rifle_Skelton`/ `SK_Rifle` / `M_Rifle` / `T_Rifle_D`
		* スケルトン / スケルタルメッシュ / マテリアル / ディフューズテクスチャ
1. ショットガンモデル用
	1. `Shotgun_Skelton`/ `SK_Shotgun` / `M_Shotgun` / `T_Shotgun_D`
		* スケルトン / スケルタルメッシュ / マテリアル / ディフューズテクスチャ
1. ロケットランチャーモデル用
	1. `Launcher_Skelton`/ `SK_Launcher` / `M_Launcher` / `T_Launcher_D`
		* スケルトン / スケルタルメッシュ / マテリアル / ディフューズテクスチャ
1. ライフルアビリティ用
	1. Actor 用ブループリント
		1. `BP_Rifle`
			* `GHOWeapon` 派生。
			* 詳細はグラフ参照。
	1. GameplayEffect
		1. `GE_RifleAiming`
			* Rifle の ADS を実行している GameplayTag を付与する GameplayEffect
		1. `GE_RifleAimingRemoval`
			* Rifle の ADS をやめたことを示す GameplayTag を付与する GameplayEffect
		1. `GE_RifleDamage`
			* Rifle のダメージ計算用の GameplayEffect
		1. `GE_RifleReload`
			* Rifle のリロード用の GameplayEffect
			* 所持している銃弾数は PlayerState の AmmoAttributeSet に保存しており、その値を GameplayTag `Data.ReloadAmount.Reserve` だけ減らす。
	1. GameplayAbility
		1. `GA_RiflePrimary` / `GA_RiflePrimaryInstant`
			* Rifle の左クリック用アビリティ。詳細はグラフのコメント参照。
		1. `GA_RifleAlternate`
			* Rifle の中央クリック用アビリティ。詳細はグラフのコメント参照。
		1. `GA_RifleSecondary`
			* Rifle の右クリック用アビリティ。詳細はグラフのコメント参照。
		1. `GA_RifleReload`
			* Rifle のリロード用アビリティ。詳細はグラフのコメント参照。
	1. GameplayCue
		1. `GC_Weapon_Rifle_Fire`
			* `GameplayCue.Weapon.Rifle.Fire` 用（ライフルの発砲用）の GameplayCue 。
	1. その他
		1. `BP_Rifle_RireCameraShake`
			* 発砲時のカメラシェイク
		1. `AM_Hero_RifleReload`
			* Rifle のリロード用 AnimMontage 。
1. UI 用
	1. HUD
		1. `WBP_HUD`
			* 武器関連の UI 追加
		1. `WBP_HUDReticle_Bullet`
			* 銃弾用のレティクルの UI 追加
1. `BP_HeroCharacterBase`
	* GASDocumentation で作成したマウスに割り当てているアビリティを外す。
		* `GA_AimDonwSights_HeroBase` / `GA_FireGun` / `GA_Meteor_HeroBase`
	* `WeaponAttachPoint` に `WeaponPoint` を指定。
	* `CapsuleComponent` のコリジョン設定を変更（詳しくはグラフ参照）
	* `CameraBoom` / `FollowCamera` の位置を銃弾が多少見やすいように調整。
1. `BP_DefaultHero`
	* 基底（ `BP_HeroCharacterBase` ）の更新により更新がかかっているが変更なし。
1. `GE_HeroAttributes`
	* `GHOAttributeSetAmmo.MaxRifleReserveAmmo` / `GHOAttributeSetAmmo.RifleReserveAmmo` の初期値設定。
1. `GA_InteactPassive`
	* デバッグ描画が on になっていたので無効化。
1. `GA_Dash`
	* GameplayTag の設定。
1. `BP_Pickup_Health`
	* `Pickup` のコリジョン設定。
1. `SK_Mannequin` / `SK_Mannequin_Skelton`
	* 骨 `head` の下にソケット `WeaponPoint` の追加。


## エンジン - Input

* `PrimaryFire`
	* Weapon の左クリックアビリティ用。
* `SecondaryFire`
	* Weapon の右クリックアビリティ用。
* `AlternateFire`
	* Weapon の中央クリックアビリティ用。
* `NextWeapon`
	* Weapon 正順変更用アビリティ用。
* `PrevWeapon`
	* Weapon 逆順変更用アビリティ用。
* `Reload`
	* Weapon 逆順変更用アビリティ用。
* `Ability1` / `Ability2` / `Ability3` / `Ability5`
	* GASDocumentation で作成したアビリティ用。
	* `Ability1` / `Ability2` / `Ability5` は Weapon の割当とかぶってしまうので `NumPad1` / `NumPad2` / `NumPad5` に割当変更。
	* `Ability3` は無関係だが、ついでに  `NumPad3` に割当変更。

## エンジン - Collision

### Object Channels

| 名前           | デフォルト応答    |
|----------------|-------------------|
| `Ability`      | Block (ブロック)  |
| `Projectile`   | Block (ブロック)  |
| `Pickup`       | Block (ブロック)  |

* `Ability` / `Projectile` の設定変更
	* GASDocument で追加していたものを変更する。（デフォルト応答を オーバーラップ -> ブロック に変更）
	* 今回の機能追加で関連があるのは `Projectile` だが、ついでに `Ability` も同様に変更しておく。
* `Pickup` の新規追加
	* 以前作成したヘルス回復のピックアップ用。
	* `Hero` のコリジョン設定が色々変わるので、ついでにここも変えておく。


### Preset

|                    |                                             |
|--------------------|---------------------------------------------|
| 名前               | `Projectile`                                |
| コリジョン Enable  | Query Only (No Physics Collision)           |
| オブジェクトタイプ | Projectile                                  |
| 説明               | Overlaps Pawns and AbilityOverlapProjectile |

| コリジョンレスポンス | 無視する | オーバーラップ | ブロック |
|----------------------|----------|----------------|----------|
| トレース型           |          |                |          |
| Visibility           | ✔       |                |          |
| Camera               | ✔       |                |          |
|                      |          |                |          |
| オブジェクト型       |          |                |          |
| WorldStatic          |          |                | ✔       |
| WorldDynamic         |          |                | ✔       |
| Pawn                 |          | ✔             |          |
| PhysicsBody          |          |                | ✔       |
| Vehicle              |          |                | ✔       |
| Destructable         |          |                | ✔       |
| Ability              | ✔       |                |          |
| Projectile           | ✔       |                |          |
| Interactable         | ✔       |                |          |
| Projectile           | ✔       |                |          |

* `TargetActorGroundLocation` / `InteractTrace`
	* `Pickup` を `無視する` にする。




## GameplayTag の追加

| タグ名                                      | 用途                                                                                                                                |
----------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| `Ability.Sprint.Cancel`                     | スプリントアビリティを他のアビリティからキャンセルするためタグ。（既に定義されているが、説明のため記載。）                          |
| `Ability.Weapon`                            | 武器用のアビリティ用のルート。                                                                                                      |
| `Ability.Weapon.Primary`                    | 左クリックした際に発火する武器のアビリティ用タグ。                                                                                  |
| `Ability.Weapon.Primary.Instant`            | 左クリックをトリガとするアビリティ内で BatchRPCTryActivateAbility() に渡す、 RPC のバッチ処理が行われるアビリティ用タグ。           |
| `Ability.Weapon.Secondary`                  | 右クリックした際に発火する武器のアビリティ用タグ。                                                                                  |
| `Ability.Weapon.Secondary.Instant`          | 未使用。右クリックをトリガとするアビリティ内で BatchRPCTryActivateAbility() に渡す、 RPC のバッチ処理が行われるアビリティ用タグ。   |
| `Ability.Weapon.Alternate`                  | 中央クリックした際に発火する武器のアビリティ用タグ。                                                                                |
| `Ability.Weapon.Alternate.Instant`          | 未使用。中央クリックをトリガとするアビリティ内で BatchRPCTryActivateAbility() に渡す、 RPC のバッチ処理が行われるアビリティ用タグ。 |
| `Ability.Weapon.Reload`                     | BP でのみ使用。                                                                                                                     |
| `Ability.Weapon.IsChanging`                 | 武器変更モーション中を示す。                                                                                                        |
| `Ability.Weapon.IsChangingDelayReplication` | 武器を変更した際に 1.5 秒だけ設定される。 連続した武器変更をサーバーとスムーズに同期するためのタグ。                                |
| `Data.ReloadAmount.Reserve`                 | リロード時、手持ちの弾薬のアトリビュートを減らす量を GameplayEffect の Modifier に渡すためのタグ。                                  |
| `Effect.Damage.CanHeadShot`                 | ダメージ計算時、ヘッドショット判定を行うかを示すタグ。                                                                              |
| `Effect.Damage.HeadShot`                    | ダメージ計算結果、ヘッドショットだったことを示すタグ。                                                                              |
| `GameplayCue.Weapon.Rifle.Fire`             | ライフル発砲時の Cue 用タグ。                                                                                                       |
| `GameplayCue.Weapon.RocketLauncher.Fire`    | ロケットランチャー発砲時の Cue 用タグ。                                                                                             |
| `GameplayCue.Weapon.RocketLauncher.Impact`  | ロケットランチャー着弾時の Cue 用タグ。                                                                                             |
| `GameplayCue.Weapon.Shotgun.Fire`           | ショットガン発砲時の Cue 用タグ。                                                                                                   |
| `Weapon.Ammo.None`                          | 無効な弾薬種別を表すタグ。                                                                                                          |
| `Weapon.Ammo.Rifle`                         | ライフルの弾薬種別を表すタグ。                                                                                                      |
| `Weapon.Ammo.Rocket`                        | ロケットランチャーの弾薬種別を表すタグ。                                                                                            |
| `Weapon.Ammo.Shotgun`                       | ショットガンの弾薬種別を表すタグ。                                                                                                  |
| `Weapon.Equipped.None`                      | 現在装備中の武器が無効な武器種別を表すタグ。                                                                                        |
| `Weapon.Equipped.Rifle`                     | 現在装備中の武器がライフルの武器種別を表すタグ。                                                                                    |
| `Weapon.Equipped.RocketLauncher`            | 現在装備中の武器がロケットランチャーの武器種別を表すタグ。                                                                          |
| `Weapon.Equipped.Shotgun`                   | 現在装備中の武器がショットガンの武器種別を表すタグ。                                                                                |
| `Weapon.Fail.Activation.OnCooldown`         | ユーザーの入力が武器の発砲可能間隔より早かった場合に `CanActivateAbility` で失敗を返す際に渡すタグ。                                |
| `Weapon.FireMode.None`                      | 無効な武器の射撃モード。武器の射撃モードがない場合に利用する。                                                                      |
| `Weapon.IsFiring`                           | 射撃中を示すタグ。射撃中に縦断の同期を行わなくするのに利用する。                                                                    |
| `Weapon.Rifle.Aiming`                       | エイムしているのを示すタグ。                                                                                                        |
| `Weapon.Rifle.Aiming.Removal`               | エイムを予測的にやめるためのタグ。                                                                                                  |
| `Weapon.Rifle.FireMode.Burst`               | 発砲モード：バースト用。                                                                                                            |
| `Weapon.Rifle.FireMode.FullAuto`            | 発砲モード：フルオート用。                                                                                                          |
| `Weapon.Rifle.FireMode.SemiAuto`            | 発砲モード：セミオート用。                                                                                                          |
| `Weapon.RocketLauncher.Aiming`              | エイムしているのを示すタグ。                                                                                                        |
| `Weapon.RocketLauncher.Aiming.Removal`      | エイムを予測的にやめるためのタグ。                                                                                                  |
| `Weapon.Shotgun.Aiming`                     | エイムしているのを示すタグ。                                                                                                        |
| `Weapon.Shotgun.Aiming.Removal`             | エイムを予測的にやめるためのタグ。                                                                                                  |
| `Weapon.Shotgun.FireMode.FullAuto`          | 発砲モード：フルオート用。                                                                                                          |
| `Weapon.Shotgun.FireMode.SemiAuto`          | 発砲モード：セミオート用。                                                                                                          |

* `Ability.Sprint.Cancel`
	* GASDocumentation / GASShooter では `Ability.CancelsSprint` として定義されている。
	* スプリントアビリティを（他のアビリティの有効化により）終了するためのタグ。
		* `GA_Sprint` 内で `Wait Gameplay Tag Add` を使用してこのタグが付与されるのを監視し、付与されたら `EndAbility` を呼び出している。
	* 武器のアビリティが有効化する際にスプリントアビリティを終了するのに使用。
		* `GA_RiflePrimary` / `GA_RifleSecondary` / `GA_RocketLauncherPrimary` / `GA_RocketLauncherSecondary` / `GA_ShotgunPrimary` / `GA_ShotgunSecondary` の `Activation Owned Tags` で指定。
* `Ability.Weapon`
	* 装備解除時にすべての武器のアビリティをキャンセルするときに使用。
		* `AGHOHeroCharacterBase::SetCurrentWeapon()` 内で `AbilitySystemComponent->CancelAbilities()` の引数で指定している。
	* 武器変更アビリティ中に他の武器アビリティの有効化を阻害するのに使用。
		* 武器変更アビリティ `GA_NextWeapon` / `GA_PreviousWeapon` の `Block Abilities with Tag` で指定。
		* ***ただし、武器変更は GAS の外で行われており、 AnimMontage の再生と同期していない（アビリティの ActivateAbility は同一フレームで EndAbility を呼び出す）。詳細は `GA_NextWeapon` / `GA_PreviousWeapon` のコメント参照。***
* `Ability.Weapon.Primary`
	* 左クリックアビリティ用のタグ。
		* 左クリックアビリティの `Ability Tags` で指定。
		* リロードアビリティが有効化する際に左クリックアビリティがキャンセルさせるのに使用。
			* リロードアビリティの `Cancel Abilities with Tag` で指定。
		* 右クリックアビリティ中に左クリックアビリティの有効化を阻害させるのに使用。
			* ロケットランチャーの右クリックアビリティの `Block Abilities with Tag` で指定。
* `Ability.Weapon.Secondary`
	* 武器の右クリック時のアビリティ用のタグ。
		* 武器の右クリックアビリティの `Ability Tags` で指定。
* `Ability.Weapon.Alternate`
	* 武器の中央クリック時のアビリティ用のタグ。
		* 武器の中央クリックアビリティの `Ability Tags` で指定。
		* ロケットランチャーには何も割り当てられていないので該当の GameplayAbility が存在しない。
* `Ability.Weapon.Primary.Instant` / `Ability.Weapon.Secondary.Instant` / `Ability.Weapon.Alternate.Instant` 共通
	* C++ 内では `AGHOHeroCharacterBase` でキャッシュを保持しているが利用はしていない模様。
* `Ability.Weapon.Secondary.Instant` / `Ability.Weapon.Alternate.Instant` 共通
	* 利用するアビリティが存在しないので使用していない。
* `Ability.Weapon.Primary.Instant`
	* 左クリック時のアビリティ内で RPC をバッチ処理するために用意された GameplayAbility 用のタグ。
		* 具体的には銃弾の処理。
		* RPC のバッチ処理については [「GASDocumentation」の「4.6.15 Ability Batching」](https://github.com/tranek/GASDocumentation#concepts-ga-batching) [（和訳）](https://github.com/sentyaanko/GASDocumentation/blob/lang-ja/README.jp.md#concepts-ga-batching) も参照。
* `Ability.Weapon.Reload`
	* `GA_RiflePrimary`
		* 左クリックアビリティが有効化する際にリロードアビリティがキャンセルさせるのに使用。
			* `Cancel Abilities with Tag` で指定。
		* 残弾がない場合にリロードアビリティを呼び出すため `Try ActivateAbilities by Tag` の引数に指定
	* `GA_RifleReload`
		* `Ability Tags` で指定。
* `Ability.Weapon.IsChanging`
	* 武器変更アビリティ `GA_NextWeapon` / `GA_PreviousWeapon` の `Ability Tags` で指定。
	* 左クリックアビリティ中に武器変更アビリティの有効化を阻害させるのに使用。
		* 左クリックアビリティの `Block Abilities with Tag` で指定。
	* 武器のアビリティ / 武器変更アビリティは武器変更の AnimMontage の特定の区間内では武器変更アビリティを有効化できなくするのに使用。
		* 武器のアビリティ / 武器変更アビリティの `Activation Blocked Tags` で指定。
			* 武器のアビリティ： `GA_RiflePrimary` / `GA_RiflePrimaryInstant` / `GA_RifleSecondary` / `GA_RifleAlternate` / `GA_RifleReload`
			* 武器変更アビリティ： `GA_NextWeapon` / `GA_PreviousWeapon`
		*  AnimMontage `AM_Hero_RifleEquip` で武器変更モーションの間、 AnimNotifyState `ANS_AddLooseGameplayTags` を使用して `AddLooseGameplayTags` / `RemoveLooseGameplayTags` を呼び出し、ローカルで GameplayTag を付与している。
			* このタグを付与しているのはここだけ。したがって、このタグはローカルにしか付与されない。
		* ***武器変更アビリティは Next / Previous の二種類があるため、同時に起動しないように抑制が必要。***
			* ***前述の通り起動直後にアビリティが終了するので一瞬のみ（同一フレーム対策になるかどうか程度の意味しかない）。***
		* ***武器変更アビリティ中の武器のアビリティの抑制は、ここまでの説明のように二重で行われている。***
			1. ***`GA_NextWeapon` / `GA_PreviousWeapon` の `Block Abilities with Tag` で `Ability.Weapon` を指定することで、武器変更アビリティが有効な間は武器のアビリティを抑制。***
				* ***前述の通り起動直後にアビリティが終了するので一瞬のみ（同一フレーム対策になるかどうか程度の意味しかない）。***
			1. ***武器のアビリティの `Activation Blocked Tags` で `Ability.Weapon.IsChanging` を指定することで、武器変更の AnimMontage の特定の期間内は武器アビリティを有効化できないようにしている。***
				* ***ローカルに付与されるタグを利用し、ローカルでのみ判定することで設定した期間だけすぐに応答し有効化できないようにしている。***
	* なんらかのアビリティの有効化に失敗した際、武器変更中かを判断するのに C++ で使用。
		* `AGHOHeroCharacter::OnAbilityActivationFailed()` にて指定。
* `Ability.Weapon.IsChangingDelayReplication`
	* 武器を変更して 1.5 秒経ってから AutonomousProxy が能動的に `CurrentWeapon` の更新処理を行うようにする仕組みで利用。
		* `GE_WeaponIsChangingDelayReplicationTag` で 1.5 秒のみ付与している。
			* 武器変更アビリティ `GA_NextWeapon` / `GA_PreviousWeapon` で上記の GameplayEffect を付与している。
		* `AGHOHeroCharacterBase` 内で、このタグが変更された際のコールバックが登録されている。
			* コールバック内では、タグの削除時に `CurrentWeapon` の更新処理が呼ばれるようになっている。
			* 詳しくは `AGHOHeroCharacterBase::WeaponChangingDelayReplicationTagChanged()` のコメント参照。
* `Data.ReloadAmount.Reserve`
	* リロード時、手持ちの弾薬のアトリビュートを減らす量を GameplayAbility で値を設定し、 GameplayEffect の Modifier に渡すためのタグ。
	* 武器の装弾数を増やすのは GameplayAbility で `AGHOWeapon::SetPrimaryClipAmmo()` を呼び出して行っている（ AttributeSet ではなく、 Actor のメンバで保持）。
	* 仕組みについて、詳しくは [「GASDocumentation」の「4.4.2.3.1 Plain Floats on the Item」](https://github.com/tranek/GASDocumentation#concepts-as-design-itemattributes-plainfloats) [（和訳）](https://github.com/sentyaanko/GASDocumentation/blob/lang-ja/README.jp.md#concepts-as-design-itemattributes-plainfloats) を参照。
* `Effect.Damage.CanHeadShot`
	* ダメージ計算時、ヘッドショット判定を行うかを示すタグ。
	* ヘッドショット判定を行うライフル/ショットガンのダメージ用 GameplayEffect `GE_RifleDamage` / `GE_ShotgunDamage` で渡し、`UGHODamageExecutionCalc` 内で参照。
* `Effect.Damage.HeadShot`
	* ダメージ計算結果、ヘッドショットだったことを示すタグ。
	* C++ のみで利用。
	* `UGHODamageExecutionCalc` で設定して `UGHOAttributeSetBase` で参照。
* `GameplayCue.Weapon.Rifle.Fire`
	* ライフル発砲時の Cue 用タグ。
* `GameplayCue.Weapon.RocketLauncher.Fire`
	* ロケットランチャー発砲時の Cue 用タグ。
* `GameplayCue.Weapon.RocketLauncher.Impact`
	* ロケットランチャー着弾時の Cue 用タグ。
* `GameplayCue.Weapon.Shotgun.Fire`
	* ショットガン発砲時の Cue 用タグ。
* `Weapon.Ammo.None`
	* 無効な弾薬種別を表すタグ。
	* `AGHOWeapon` の `PrimaryAmmoType` / `SecondaryAmmoType` の初期値、 `AGHOHeroCharacterBase::AddWeaponToInventory()` の中などで利用。
* `Weapon.Ammo.Rifle` / `Weapon.Ammo.Rocket` / `Weapon.Ammo.Shotgun` 共通
	* アトリビュートセットから各弾薬種別の所持数を取得する際に利用。
		* `UGHOAmmoAttributeSet` の `GetReserveAmmoAttributeFromTag()` / `GetMaxReserveAmmoAttributeFromTag()` の中で利用。
* `Weapon.Ammo.Rifle`
	* ライフルの弾薬種別を表すタグ。
	* `BP_Rifle` の `PrimaryAmmoType` で指定。
* `Weapon.Ammo.Rocket`
	* ロケットランチャーの弾薬種別を表すタグ。
	* `BP_RocketLauncher` の `PrimaryAmmoType` で指定。
* `Weapon.Ammo.Shotgun`
	* ショットガンの弾薬種別を表すタグ。
	* `BP_Shotgun` の `PrimaryAmmoType` で指定。
* `Weapon.Equipped.None`
	* 無効な武器種別を表すタグ。
	* `AGHOHeroCharacterBase::CurrentWeaponTag` の初期値、 `AGHOHeroCharacterBase::UnEquipCurrentWeapon()` の中などで利用。
* `Weapon.Equipped.Rifle` / `Weapon.Equipped.RocketLauncher` / `Weapon.Equipped.Shotgun` 共通
	* 一人称視点用のキャラクターのアニメーションブループリントで武器ごとのモーションを使用するために利用。
		* GASShooter の `ABP_Hero1P` で利用。
			* モーション的にはライフルとショットガンで同じものを使っているため、 `Weapon.Equipped.Shotgun` は使用していない。
* `Weapon.Equipped.Rifle`
	* ライフルの武器種別を表すタグ。
		* `BP_Rifle` の `Weapon Tag` で指定。
* `Weapon.Equipped.RocketLauncher`
	* ロケットランチャーの武器種別を表すタグ。
		* `BP_RocketLauncher` の `Weapon Tag` で指定。
* `Weapon.Equipped.Shotgun`
	* ショットガンの武器種別を表すタグ。
		* `BP_Shotgun` の `Weapon Tag` で指定。
* `Weapon.Fail.Activation.OnCooldown`
	* ユーザーの入力が武器の発砲可能間隔より早かった場合に `CanActivateAbility` で失敗を返す際に渡すタグ。
		* 失敗した場合は `AGHOHeroCharacter::OnAbilityActivationFailed()` に渡される。
		* ***が、このタグを利用していない。不要？***
* `Weapon.FireMode.None`
	* 無効な武器の射撃モード。武器の射撃モードがない場合に利用する。
	* `BP_RocketLauncher` の `DefaultFireMode` で利用。
	* ***各武器ごとの FireMode にも言えるが、ブループリント内で完結しており、 C++ では参照していない。***
* `Weapon.Rifle.FireMode.Burst` /  `Weapon.Rifle.FireMode.FullAuto` / `Weapon.Rifle.FireMode.SemiAuto` / `Weapon.Shotgun.FireMode.FullAuto` / `Weapon.Shotgun.FireMode.SemiAuto` 共通
	* `AGHOWeapon` の `FireMode` に保存。
* `Weapon.IsFiring`
	* 射撃中を示すタグ。射撃中に銃弾の同期を行わなくするのに利用する。
	* 仕組みについて、詳しくは [「GASDocumentation」の「4.4.2.3.1 Plain Floats on the Item」](https://github.com/tranek/GASDocumentation#concepts-as-design-itemattributes-plainfloats) [（和訳）](https://github.com/sentyaanko/GASDocumentation/blob/lang-ja/README.jp.md#concepts-as-design-itemattributes-plainfloats) を参照。
* `Weapon.Rifle.*` / `Weapon.RocketLauncher.*` / `Weapon.Shotgun.*`
	* ***ブループリント内で完結している。***
* `Weapon.Rifle.Aiming` / `Weapon.Rifle.Aiming.Removal`
	* エイムしている / 予測的にやめるのを示すタグ。
	* エイムをしているかどうかを判定するのに使用。
	* `GE_RifleAiming` / `GE_RifleAimingRemoval` の `GrantedTags` で指定。
* `Weapon.Rifle.FireMode.Burst` /  `Weapon.Rifle.FireMode.FullAuto` / `Weapon.Rifle.FireMode.SemiAuto`
	* 発砲モード：バースト用 / フルオート用 /セミオート用。
	* `GA_RifleAlternate` で射撃モードを変更する際に使用。
	* `GA_RiflePrimary` で射撃の処理の際、現在の射撃モードを判定するために使用。
* `Weapon.RocketLauncher.Aiming` / `Weapon.RocketLauncher.Aiming.Removal`
	* エイムしている / 予測的にやめるのを示すタグ。
	* エイムをしているかどうかを判定するのに使用。
	* `GE_RocketLauncherAiming` / `GE_RocketLauncherAimingRemoval` の `GrantedTags` で指定。
* `Weapon.Shotgun.Aiming` / `Weapon.Shotgun.Aiming.Removal`
	* エイムしている / 予測的にやめるのを示すタグ。
	* エイムをしているかどうかを判定するのに使用。
	* `GE_ShotgunAiming` / `GE_ShotgunAimingRemoval` の `GrantedTags` で指定。
* `Weapon.Shotgun.FireMode.FullAuto` / `Weapon.Shotgun.FireMode.SemiAuto`
	* 発砲モード：フルオート用 / セミオート用。
	* `GA_ShotgunAlternate` で射撃モードを変更する際に使用。
	* `GA_ShotgunPrimary` で射撃の処理の際、現在の射撃モードを判定するために使用。


以上で、 HeroCharacter で武器を使用することができるようになります。

-----
# 補足

-----
## Loose な GameplayTag

* 以下の 2 つのタグで使用されている。
	1. `Ability.Weapon.IsChanging`
		* `AM_Hero_RifleEquip`
			* 武器変更モーションの特定の期間だけ Loose に付与している。
				* 目的としては上記タグが付与されている間、武器のアビリティと武器を変更するアビリティを起動できないようにするため。
				* 操作に関するものなので、他のクライアントと共有する必要がなく、 Loose な GameplayTag を使用している。
	1. `State.Dead`
		* `UGHOAbilitySystemComponent::Die()`
			* Health 変更のデリゲート内で Health が 0 以下になったミニオンにだけ Loose に付与している。
				* サーバー、クライアとともに独自に Loose に付与していることになる。
				* このタグを付与される前に `RemoveCharacterAbilities()` によりキャラクターに付与されたアビリティが削除される。
				* そのため、死亡後のミニオンのアビリティの起動抑制等には影響せず、用途としてはロジック上の死亡判定のみとなる。
					* ロジック上の使用も前述の Health 変更のデリゲート内の死亡処理を行うかの判定のみ。
					* つまりは Health が 0 以下に変更する通知が複数回来たときに、死亡処理を何度も行う判定のみに使用されている。
					* ***なお、 GASShooter には GASDocumentation で実装されていたミニオンがない為、無関係。***
			* ***Hero に関してはフローが異なり、`GE_Dead` により普通に付与される。***
* GASShooter では上記に加え、 `ABP_Hero1P` で武器毎のアニメーションを再生するために使用している。
	* 1PV Mesh に関する情報なため、他のクライアントと共有する必要がなく、 Loose な GameplayTag を使用している。


-----
## TargetActor

* `AGHOGATA_Trace`
	* `Engine\Plugins\Runtime\GameplayAbilities\Source\GameplayAbilities\Public\Abilities\GameplayAbilityTargetActor_Trace.h` の `AGameplayAbilityTargetActor_Trace` を元にしていると思われる。
	* 大幅な拡張なので、元のコードとはかなり異なっている。
	* 概ね以下のような拡張を行っている。
		* 使い捨てではなくインスタンスを何度も利用できるに様にする仕組み
			* この機能を使用するため、 `UGHOAbilityTask_WaitTargetDataUsingActor` と一緒に使うことが想定されています。
		* ゲームシステムに絡む拡張
			* 複数のターゲティングを行う仕組みの追加
			* リコイルによるターゲティングのブレを行う仕組みの追加
			* ショットガンのように複数のライントレースを行う仕組み
* `GHOGATA_LineTrace.cpp` / `GHOGATA_LineTrace.h`
	* ライフルで利用しています。
	* ショットガンでも使用することになります。
* `GHOGATA_SphereTrace.cpp` / `GHOGATA_SphereTrace.h`
	* ロケットランチャーのセカンダリアビリティのホーミングロケットのロックオンターゲティングで使用することになります。
	* まだ使用していないので詳細は把握していません。


-----
## TargetType

* `UGHOTargetType` / `UGHOTargetType_UseOwner` / `UGHOTargetType_UseEventData`
	* GameplayEffect を付与する対象を静的に指定する際に使用するクラス。
		* `UGHOTargetType_UseOwner` は TargetingCharacter（== ASC のOwner の AvatarActor ）を使用します。
			* `GA_RifleReload` で利用。
		* `UGHOTargetType_UseEventData` は渡された `EventData.ContextHandle.GetHitResult()` が有効ならばそれを、あるいは`EventData.Target` が有効ならばそれを使用します。
			* GASShooter でも利用されていません。
			* 利用箇所がないため、どういった意図か把握できていません。


-----
## GameplayEffectContainer

* `FGHOGameplayEffectContainer`
	* TargetType class と GameplayEffect class 配列 をペアで保存する構造体。
	* つまり、とある状況で、予め決まった GameplayEffect 群を予め決まった TargetType に適用したいアビリティにて静的に定義するのに使用できます。
	* この構造体は `UGHOGameplayAbility` に GameplayTag をキーとした連想配列で保持できるようにしていて、使用しているのはここだけである。
		* `UGHOGameplayAbility` から派生したブループリント内で、任意の GameplayTag とペアで保持する。
			* ここで指定する GameplayTag は他の機能に何ら影響しない、単なる特定のためのキー。
			* 保持の方法が連想配列なのは、可読性のためのように見受けられる。
				* （配列で保持し、インデックスで指定という形でも機能的には何ら問題ない）
		* このような情報を持つことで、ブループリントのグラフ内で `FGHOGameplayEffectContainerSpec` のインスタンスを取得できるようにしている。
			* なおこのインスタンスは毎回作られる。キャッシュ的な意味はない。
* `FGHOGameplayEffectContainerSpec`
	* `FGameplayAbilityTargetDataHandle` と GameplayEffect インスタンス配列をペアで保存する構造体。
		* `FGameplayAbilityTargetDataHandle` の詳細は別項参照。
			* 少しだけ補足
				* このクラスは複数のターゲティングデータ `FGameplayAbilityTargetData` を内部で保持する構造体。
				* `FGameplayAbilityTargetData` は複数のターゲットとなる情報（アクターもしくは座標に類する情報）の保持を行うインターフェイス構造体（データメンバを持たない）。
	* `FGHOGameplayEffectContainer` を元に作られる、具体的なインスタンスを持つ構造体。
	* `UGHOGameplayAbility::MakeEffectContainerSpec()` にキーとなる GameplayTag を指定することで構築できる。


-----
## UGHOAbilityTask_WaitTargetDataUsingActor

* `UAbilityTask_WaitTargetData` の独自拡張。
	* `Engine\Plugins\Runtime\GameplayAbilities\Source\GameplayAbilities\Public\Abilities\Tasks\AbilityTask_WaitTargetData.h` で定義されている。
* Rifle での利用
	* `GA_RiflePrimaryInstant` の `FireBullet` にて使用。
	* 注意： `Wait Target Data with Reusable Actor` ノードへは `LocallyControlled` （＝呼び出したクライアント、もしくはホスト）しか到達しないので、以下はそれが前提。
	* `Confirmation Type` が `Instant` で指定されているので、主要な処理は以下のように流れる。
		* 基底クラスの `UGameplayTask` から `UGHOAbilityTask_WaitTargetDataUsingActor::Activate()` が呼ばれる。
		* `UGHOAbilityTask_WaitTargetDataUsingActor::InitializeTargetActor()` にて `TargetActor->TargetDataReadyDelegate` デリゲートに `UGHOAbilityTask_WaitTargetDataUsingActor::OnTargetDataReadyCallback` を登録。
		* `UGHOAbilityTask_WaitTargetDataUsingActor::RegisterTargetDataCallbacks()` での処理はサーバー用のものなので無関係。
			* 主要な処理は `if (!bIsLocallyControlled)` の内側なので、実質的には何もしない。
		* `UGHOAbilityTask_WaitTargetDataUsingActor::FinalizeTargetActor()` にて以下の呼び出し。
			* `TargetActor->StartTargeting()` == `AGHOGATA_Trace::StartTargeting()`
			* `TargetActor->ConfirmTargeting()` == `AGameplayAbilityTargetActor::ConfirmTargeting()`
				* `AGHOGATA_Trace::ConfirmTargetingAndContinue()`
				* `AGHOGATA_Trace::MakeTargetData()`
					* LineTrace により、 HetResults を生成し、 TargetData として利用可能にする
					* `TargetDataReadyDelegate.Broadcast()` == `UGHOAbilityTask_WaitTargetDataUsingActor::OnTargetDataReadyCallback()`
						* `AbilitySystemComponent->CallServerSetReplicatedTargetData()` により、サーバーに TargetData がレプリケーションされる。
						* `ValidData.Broadcast()` の呼び出しにより、 `Wait Target Data with Reusable Actor` ノードの `Valid Data` ピンの接続先 `Handle Target Data` に処理が流れる。
* その他
	* `Confirmation Type` が `Instant` での動作確認しか行っていないため、他を指定した場合の挙動は未検証。

-----
## UGHOAbilityTask_ServerWaitForClientTargtData

* Rifle での利用
	* `GA_RiflePrimaryInstant` の `ActivateAbility` にて使用。
	* `Sever Wait for Client Target Data` ノードは、基本的にはブループリント内のコメントにある通り。
		* クラアントでは何もせず即終了、
		* サーバーでは AbilityTask が立ち上がりっぱなしになり、 TargetData を待ち受ける状態となる。
	* サーバ側では以下のような流れとなる。
		* `AbilitySystemComponent->AbilityTargetDataSetDelegate()` を使用して TargetData 設定時のデリゲートに `UGHOAbilityTask_ServerWaitForClientTargetData::OnTargetDataReplicatedCallback` を登録
		* 前項の `UGHOAbilityTask_WaitTargetDataUsingActor` によりクライアントから TargetData が送られて来るのを待つ。
		* `UGHOAbilityTask_ServerWaitForClientTargetData::OnTargetDataReplicatedCallback()` が呼び出される
			* `ValidData.Broadcast()` の呼び出しにより、 `Sever Wait for Client Target Data` ノードの `Valid Data` ピンの接続先 `Handle Target Data` に処理が流れる。


-----
## GA_RiflePrimary/GA_RiflePrimaryInstant/GA_RifleSecondary/GA_RifleAlternate/GA_RifleReload

設定のなかでも特徴的な部分だけ比較

|                | Abllity Imput ID | Abllity ID     |  Net Execution Policy |
| -------------- | ---------------- | -------------- | --------------------- |
| Primary        | Primary Fire     | Primary Fire   |  Local Only           |
| PrimaryInstant | None             | Primary Fire   |  Local Predicted      |
| Secondary      | Secondary Fire   | Secondary Fire |  Local Predicted      |
| Alternate      | Alternate Fire   | Alternate Fire |  Local Only           |
| Reload         | Reload           | Reload         |  Local Predicted      |

* PrimaryInstant は入力が割り当てられていない。
* Primary/PrimaryInstant は Ability ID が重複している。
	* Ability ID はアビリティレベル取得に使用する。現状は 1 固定。
	* 同一の（アビリティレベルを参照する）アビリティとして扱う設定、ということ。
* Primary/Reload はクライアントサイドで処理される。


-----
## GA_RiflePrimary

* `ActivateAbility`
	* `Local Onry` で実行されます。
	* 入力があると呼ばれるイベントです。
	* Fire Mode に従って、 `RPC` のバッチ処理の設定をしつつ `GA_RiflePrimaryInstant` のアクティベートを行います。
		* `Semi Auto` の場合は単発処理して終了します。
		* `Full Auto` の場合は入力が開放されるか弾切れになるまでループした後終了します。
		* `Burst` の場合は入力が開放されるか三発撃つか弾切れになるまでループした後終了します。
	* 連射の場合、 `Wait Delay` や `Repeat Action` で期間を空けていますが、クライアント側の処理なのでチートを受ける可能性があります。
		* 実際の発砲処理はサーバー側でも処理される `GA_RiflePrimaryInstant` 側で行っており、そちらで想定外の発砲可能間隔の場合は蹴られます。
* `GHOCheckCost`
	* コストのチェック、つまり Ammo のチェックを行っています。
	* さらに、 `GA_RiflePrimary` が有効化していない状態でコストチェックを行った結果が失敗の場合（＝つまりは装弾されていない状態でアビリティを起動しようとした場合）は `Try Activate Abilities by Tag` でリロードアビリティの起動を試みます。
	* 詳細はグラフ内のコメント参照。

-----
## GA_RiflePrimaryInstant

* `ActivateAbility`
	* `Local Predicted` で実行されます。
	* `GA_RiflePrimary` から呼ばれます。
	* 銃弾一発づつの処理です。
	* `Server Wait for Client Target Data` で
		* サーバーは クライアントから TargetData が送られるのを待つタスクを起動し、 `Handle Target Data` でデータが来るのを待ちます。
		* クライアントは特に何もしません。
	* `Fire Bullet` を呼び出します。
* `Fire Bullet`
	* 先頭で `Is Local Player Controller` のチェックを行い、自身のクライアントで操作していない場合はそこで終了します。
		* Host の場合は他のクライアント
		* 専用サーバーの場合はすべて
		* 他のクライアントの場合はそもそも来ないので無関係
	* 前回の発砲からの経過時間のチェック
	* Weapon で保持している TargetActor を使用して `Wait Target Data with Reusable Actor` を呼び出します。
		* LineTrace を行い、結果を `Handle Target Data` に渡し、サーバーにもレプリケーションします。
* `Handle Target Data`
	* サーバーは `Server Wait for Client Target Data` の `Valid Data` ピン経由で呼び出されます。
	* クライアントは `Wait Target Data with Reusable Actor` の `Valid Data` ピン経由で呼び出されます。
	* `GE_RifleDamage` を`ApplyGameplayEffectSpecToTarget` を使用して、ターゲットにダメージを与えます。
		* `GE_RifleDamage` は `ExecutionCalculation` を使用しており、この計算はサーバーのみで行われ、結果がクライアントにレプリケーションされます。
	* `Execute GameplayCueWithParameter On Owner` に GameplayTag `GameplayCue.Weapon.Rifle.Fire` を指定して呼び出すことで `GC_Weapon_Rifle_Fire` を再生します。

-----
## GC_Weapon_Rifle_Fire

* カメラシェイク、マズルフラッシュ、銃弾のトレイル、着弾点のパーティクル、銃声、着弾音、などの再生を行います。
* クライアントごとに何を再生するかの調整も行っています。詳細はグラフ参照。

-----
## GA_RifleSecondary

* ADS を行っています。
* 基本的な部分は GASDocumentation のものとほとんど同じです。
* FOV の変化を徐々に行うため、 AbilityTask `Wait Change FOV` を使用しています。

-----
## GA_RifleAlternate

* `ActivateAbility`
	* `Local Onry` で実行されます。
	* 入力があると呼ばれるイベントです。
	* Fire Mode を循環的に切り替えます。
	* Fire Mode は他のクライアントから参照されない情報なので全てローカルで賄っています。

-----
## GA_RifleReload

* `ActivateAbility`
	* `Local Predicted` で実行されます。
	* 入力があると呼ばれるイベントです。
	* リロード用の AnimMontage の再生を行っている。
		* リロードの処理の詳細は別項参照。
	* `Wait Net Sync` については [「GASDocumentation」の「4.10.2 Creating New Prediction Windows in Abilities」](https://github.com/tranek/GASDocumentation#concepts-p-windows) [（和訳）](https://github.com/sentyaanko/GASDocumentation/blob/lang-ja/README.jp.md#concepts-p-windows) も参照。
	* AttributeSetAmmo で保持している予備弾薬を GameplayEffect で減らしている。
	* Weapon で保持している装弾数を `SetPrimaryClipAmmo` で増やしている。
	* 参考： GASShotter での実装
		* 1PV/3PV のメッシュがあるため、 `Play Montage Fro Mesh and Wait for Event` を作成し、使用している。
			* これは `Play Montage and Wait for Event` では一つの AnimMontage の制御しかできないため。
			* GASHandsOn では、複数メッシュを持っていないので、関連コードはすべてコメントアウトしている。
				* 関連コードについてはコミット d56ab0f9b4c05bbe1cb48ea934967341d86224da で追加しているので、そちらを参照。
* `K2_CanActivateAbility`
	* アビリティの有効化の前に呼び出されます。
	* 弾倉に空きがあり、予備の弾薬がある場合のみ有効化できるようにしています。


-----
## FGameplayAbilityTargetData
 
[Unreal Engine 4.26 Documentation > Unreal Engine API Reference > Plugins > GameplayAbilities > Abilities > FGameplayAbilityTargetData](https://docs.unrealengine.com/4.26/en-US/API/Plugins/GameplayAbilities/Abilities/FGameplayAbilityTargetData/)

```c++
/**
by Epic
	A generic structure for targeting data. 
	We want generic functions to produce this data and other generic functions to consume this data.

	We expect this to be able to hold specific actors/object reference and also generic location/direction/origin information.

	Some example producers:
		-Overlap/Hit collision event generates TargetData about who was hit in a melee attack
		-A mouse input causes a hit trace and the actor infront of the crosshair is turned into TargetData
		-A mouse input causes TargetData to be generated from the owner's crosshair view origin/direction
		-An AOE/aura pulses and all actors in a radius around the instigator are added to TargetData
		-Panzer Dragoon style 'painting' targeting mode
		-MMORPG style ground AOE targeting style (potentially both a location on the ground and actors that were targeted)

	Some example consumers:
		-Apply a GameplayEffect to all actors in TargetData
		-Find closest actor from all in TargetData
		-Call some function on all actors in TargetData
 		-Filter or merge TargetDatas
		-Spawn a new actor at a TargetData location

	Maybe it is better to distinguish between actor list targeting vs positional targeting data?
		-AOE/aura type of targeting data blurs the line
和訳
	ターゲティングデータ用の汎用的な構造体です。
	このデータを生成するための汎用関数と、このデータを利用するための別の汎用関数が必要です。

	これは、特定のアクター/オブジェクトの参照や、一般的な位置/方向/原点の情報の保持を意図しています。

	いくつかの生成方法の例：
		-Overlap/Hit コリジョンイベントは、近接攻撃で誰が殴られたかという TargetData を生成します。
		-マウス入力でヒットトレースが発生し、クロスヘア（十字線）の前にあるアクターが TargetData になります。
		-マウス入力でオーナーのクロスヘア（十字線）の視点の原点/方向からTargetDataを生成します。
		-AOE(Area Of Effect)/オーラ （範囲内にバフなどの効果を及ぼすゲームシステムのこと）が発振し、 instigator を中心とした園内のすべてのアクターが TargetData に追加されます。
		-パンツァードラグーンスタイルの「ペイント」ターゲティングモード。（ロックオンホーミングレーザーのロック時のこと？）
		-MMORPG スタイルの地上 AOE ターゲティングスタイル（潜在的に、地面の位置とターゲティングされたアクターの両方がターゲットされる）


	いくつかの利用方法の例：
		-GameplayEffect を TargetData 内の全アクターに適用
		-TargetData 内の全アクターから最も近いものを検索
		-TargetData 内の全アクターに対して何らかの関数を呼び出す
 		-複数の TargetData のフィルタリングやマージ
		-TargetData の位置に新しいアクターのスポーン

	アクターリストターゲティングとポジショナルターゲティングのデータは区別したほうが良いのでは？
		-AOE(Area Of Effect)/オーラ タイプのターゲティングは、その境界線が曖昧です。
*/
USTRUCT()
struct GAMEPLAYABILITIES_API FGameplayAbilityTargetData
```

* 用途はコード内のコメントのとおり。
* この構造体はデータメンバを持っていない、インターフェイスクラス的な構造体。
	* 派生構造体 `FGameplayAbilityTargetData_LocationInfo` / `FGameplayAbilityTargetData_ActorArray` / `FGameplayAbilityTargetData_SingleTargetHit` 等がある。
		* それぞれに関しては各項参照。
* 内部にターゲットとなる複数の Actor を保持することを想定している。



-----
## FGameplayAbilityTargetData_LocationInfo
 
[Unreal Engine 4.26 Documentation > Unreal Engine API Reference > Plugins > GameplayAbilities > Abilities > FGameplayAbilityTargetData_LocationInfo](https://docs.unrealengine.com/4.26/en-US/API/Plugins/GameplayAbilities/Abilities/FGameplayAbilityTargetData_Locat-/)

```c++
/**
by Epic
	Target data with just a source and target location in space 
和訳
	空間上のソースとターゲットの位置だけのターゲットデータ
*/
USTRUCT(BlueprintType)
struct GAMEPLAYABILITIES_API FGameplayAbilityTargetData_LocationInfo : public FGameplayAbilityTargetData
```

-----
## FGameplayAbilityTargetData
 
[Unreal Engine 4.26 Documentation > Unreal Engine API Reference > Plugins > GameplayAbilities > Abilities > FGameplayAbilityTargetData](https://docs.unrealengine.com/4.27/en-US/API/Plugins/GameplayAbilities/Abilities/FGameplayAbilityTargetData_Actor-/)

```c++
/**
by Epic
	Target data with a source location and a list of targeted actors, makes sense for AOE attacks
和訳
	ソース位置とターゲットされたアクターのリストからなるターゲットデータ、 AOE 攻撃に有用
*/
USTRUCT(BlueprintType)
struct GAMEPLAYABILITIES_API FGameplayAbilityTargetData_ActorArray : public FGameplayAbilityTargetData
```

-----
## FGameplayAbilityTargetData_SingleTargetHit
 
[Unreal Engine 4.26 Documentation > Unreal Engine API Reference > Plugins > GameplayAbilities > Abilities > FGameplayAbilityTargetData_SingleTargetHit](https://docs.unrealengine.com/4.26/en-US/API/Plugins/GameplayAbilities/Abilities/FGameplayAbility-_1//)

```c++
/**
by Epic
	Target data with a single hit result, data is packed into the hit result
和訳
	一つのヒットリザルトからなるターゲットデータ、データはヒットリザルトにパックされる。
*/
USTRUCT(BlueprintType)
struct GAMEPLAYABILITIES_API FGameplayAbilityTargetData_SingleTargetHit : public FGameplayAbilityTargetData
```

-----
## FGameplayAbilityTargetDataHandle
 
[Unreal Engine 4.26 Documentation > Unreal Engine API Reference > Plugins > GameplayAbilities > Abilities > FGameplayAbilityTargetDataHandle](https://docs.unrealengine.com/4.26/en-US/API/Plugins/GameplayAbilities/Abilities/FGameplayAbilityTargetDataHandle/)

```c++
/**
by Epic
	Handle for Targeting Data. This servers two main purposes:
		-Avoid us having to copy around the full targeting data structure in Blueprints
		-Allows us to leverage polymorphism in the target data structure
		-Allows us to implement NetSerialize and replicate by value between clients/server

		-Avoid using UObjects could be used to give us polymorphism and by reference passing in blueprints.
		-However we would still be screwed when it came to replication

		-Replication by value
		-Pass by reference in blueprints
		-Polymophism in TargetData structure
和訳
	ターゲティングデータ用のハンドルです。これについては 2 つの主な目的があります：
		-ブループリントで完全なターゲティングデータ構造体をコピーする必要がない。
		-ターゲットのデータ構造でポリモーフィズムを利用することができる。
		-NetSerialize を実装することで、クライアント/サーバー間で値をレプリケーションできる。

		-UObject を避けることで、ポリモーフィズムと参照渡しをブループリント内で使用することができる。
		-しかしながら、レプリケーションに関しては、まだ問題があります。

		-値によるレプリケーション
		-ブループリントでの参照渡し
		-TargetData構造のポリモーフィズム
*/
USTRUCT(BlueprintType)
struct GAMEPLAYABILITIES_API FGameplayAbilityTargetDataHandle
```

* ***複数の***ターゲティングデータを保持する構造体。
	* 具体的には `FGameplayAbilityTargetData` へのシェアードポインタの配列を保持している。

-----
## GASShooter の各 1PV Mesh で行っていること

* レプリケーション対象ではない。
	* 無理やり表示させない限り、自分が操作しているキャラクターのみしか表示されないので、レプリケーションする意味がない。
	* そのため、各処理の書き方次第で伝播する範囲が変わる。
* 発砲
	* 1PV Mesh にしか AnimMontage が存在しない。
		* （そのため、他のクライアントからは射撃しているかどうかは発砲エフェクトを見ないとわからない。）
	* AutonomousProxy および Authority のみでの射撃モーションの再生している。
		* `GA_RiflePrimariyInstant` などでモーションを再生しているが、該当ノードに到達するのが上記 2 つのロールのみ。
* ADS
	* 1PV Mesh にしか AnimMontage が存在しない。
		* （見えないため、他のクライアントからは ADS しているかどうかはわからない。）
	*  AnimMontage の適用は `ABP_Hero1P` 内で GameplayTag `Weapon.Rifle.Aiming` などの状況により設定される。
		* （見えないが、全クライアントに適用されている。）
* リロード
	* 1PV/3PV Mesh 両方の AnimMontage を再生しているが、前者はレプリケーションしていない。
		* `GA_RifleReload` の `Play AnimMontage for Mesh and Wait for Event` の `Replicate Montage` に `false` / `true` をそれぞれ指定している。
	* そのため、基本的には 1PV は AutonomousProxy および Authority のみで再生される。
		* `GA_RifleReload` の `Net Execution Policy` が `Local Predicated` の為。
	* 但し、 ADS 中にリロードを行うと SimulatedProxy でもモーションの再生が行われる。
		* 原因は、 ADS /リロードのどちらも FullBody スロットを使っているせいだと思われるが、詳細は確認していないので不明。

-----
## リロード処理の流れ

* GameplayAbility 内の処理
	* リロード用の AnimMontage の再生を行う。その際、 `Ability.Weapon.Reload` イベントを監視する。
		*  AnimMontage 内で AnimNotify を使用して `Ability.Weapon.Reload` イベントが発生するようにしている。
		* 上記イベントが発生したら Ammo を補充する。
* リロードアビリティと左クリックアビリティ
	* 互いに `Cancel Abilities with Tags` で指定している。
	* そのため、一方のアビリティが発動中にもう一方が発動するとキャンセルがかかる。
	* 左クリックアビリティによるリロードアビリティのキャンセル
		* Ammo がある時はキャンセルがかかる。
		* Ammo が 0 の間は左クリックアビリティのコストチェックで失敗するので、左クリックアビリティが発動せずキャンセルがかからない。
		* リロードアビリティ処理の中で Ammo が補充されるが、その時点で左クリックアビリティのコストチェックが成功し左クリックアビリティが発動するようになる。
			* つまりは Ammo が 0 の時に発動したリロードアビリティは途中までキャンセルがかからず、途中からキャンセルがかかるようになっている。
* リロードキー入力時
	* アビリティにキーを割り当てることでキー入力時にリロードアビリティを発動している。
* 左クリック時
	* Ammo が 0 の場合、左クリックアビリティのコストチェックの際、失敗を返す前にリロードアビリティを発動している。
		* `Try Activate Abilities by Tag` で `Ability.Weapon.Reload` を指定して発動している。
		* Ammo が補充される前の２回目以降の呼び出しは（アビリティが既に発動しているので） `Try Activate Abilities by Tag` が失敗する。
	* Ammo が補充されると「左クリックアビリティのコストチェック」が成功するようになり、左クリック時のアビリティが発動する。
		* その結果、リロードアビリティはキャンセルがかかり、 `Play AnimMontage for Mesh and Wait for Event` で AnimMontage の再生の完了を待たず `On Cancelled` が呼び出さされ、そこで `CancelAbility` を実行している。
* このようにして、
	* リロードアビリティの発動を行い（リロードキー入力による発動、又は左クリックアビリティのコストチェックの際にコスト不足ならリロードアビリティの発動）、 
	* Ammo が 0 の間は左クリックアビリティの発動を抑制し（コストチェックで false を返すことでアビリティの発動を抑制）、 
	* （リロードアビリティの多重発動抑制は特にしていない（もともと同一の GameplayAbility を多重に発動できないので、 `Try Activate Abilities by Tag` が失敗を返すのに任せている））
	* リロードアビリティの途中で Ammo を補充し（ AnimMontage 再生時にイベントの発生を監視し、イベント発生時に Ammo を補充）、
	* Ammo が補充された時点で左クリックアビリティの発動が可能となり（コストチェックで true を返せるようになるのでアビリティの発動が可能）、
	* 左クリックアビリティの発動時にリロードアビリティをキャンセルするようになっている（キャンセルタグの指定によるリロードアビリティのキャンセル、 AnimMontage 再生タスクの中断、およびアビリティのキャンセル）。


-----
## AGHOHeroCharacterBase::EquipWeapon() について

* 関数単体で、 Net Role 毎に以下のような処理を行う。
	* `Authority` では
		* `SetCurrentWeapon()` を呼び出すことにより `CurrentWeapon` の owner の設定等を行う。
	* `Authority` 以外では
		* `RPCServerEquipWeapon()` を呼び出し、サーバー側で `RPCServerEquipWeapon_Implementation()` -> `EquipWeapon()` を呼び出すようにする。 
		* `SetCurrentWeapon()` を呼び出すことにより `CurrentWeapon` の owner の設定等を行う。
		* `bChangedWeaponLocally` を立ててローカル予測状態であることをわかるようにする。
* ただし、実際にこの関数は `Authority` / `AutonomousProxy` でしか呼び出されない。
	* 呼び出し元は以下の四箇所。
		1. `AddWeaponToInventory()`
			* `SpawnDefaultInventory()` から呼び出される。
				* この関数の先頭で ```if (GetLocalRole() < ROLE_Authority){return;}``` しているため、 ***`AddWeaponToInventory()` は `Authority` からのみ呼び出される***。
		1. `NextWeapon()` / `PreviousWeapon()`
			* `GA_NextWeapon` / `GA_PreviousWeapon`
				* この GameplayAbility の `Net Execution Policy` は `Local Predicted` であり、 `Ability Input ID` で割り当てられたキー入力を元に起動される。
				* そのため、挙動としては、 [「GASDocumentation」の「4.6.4 Activating Abilities」](https://github.com/tranek/GASDocumentation#concepts-ga-activating) [（和訳）](https://github.com/sentyaanko/GASDocumentation/blob/lang-ja/README.jp.md#concepts-ga-activating) にある `locally predicted （ローカル予測） された GameplayAbilities の有効化シーケンス` のような流れとなる。
				* 端的に言えば ***`AutonomousProxy` / `Authority` の両方から呼び出され、 `SimulatedProxy` からは呼び出されない***。
		1. `ServerEquipWeapon_Implementation()`
			* `EquipWeapon()`
				* この関数の ```if (GetLocalRole() < ROLE_Authority)``` で括られた箇所からの呼び出しのため、 `Authority` 以外からのみ呼び出される。
	* `ServerEquipWeapon()` 自体が `EquipWeapon()` からのみ呼び出されるため、実質的には `AddWeaponToInventory()` / `NextWeapon()` / `PreviousWeapon()` が呼び出し元となる。
* `ServerEquipWeapon()` の呼び出しについて
	* 不要と思われる。以下はその理由。
		* `ServerEquipWeapon()` は、 `Authority` で `EquipWeapon()` を呼び出すための関数。
		* `AddWeaponToInventory()` はそもそも `Authority` で呼び出されるため、無関係。
		* `NextWeapon()` / `PreviousWeapon()` は `AutonomousProxy` / `Authority` の両方から呼び出されるため、ことさら `EquipWeapon()` 内で `ServerEquipWeapon()` を呼び出さなくても `Authority` 側でも `NextWeapon()` / `PreviousWeapon()` 経由で `EquipWeapon()` が呼び出される。
	* よって、`GASHandsOn` では `ServerEquipWeapon()` の呼び出しをコメントアウトしています。

-----
## CurrentWeapon の同期の流れ

### AutonomousProxy での CurrentWeapon の初期化
#### Case1: PlayerState -> Inventory の順にレプリケーションされた場合
![CurrentWeapon-Initialize-AutonomousProxy-Case1](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/sentyaanko/GASHandsOn/main/Documents/0.1.7/CurrentWeapon-Initialize-AutonomousProxy-Case1.puml)

#### Case2: Inventory -> PlayerState の順にレプリケーションされた（ RPCServerSyncCurrentWeapon のほうが早かった）場合
![CurrentWeapon-Initialize-AutonomousProxy-Case2](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/sentyaanko/GASHandsOn/main/Documents/0.1.7/CurrentWeapon-Initialize-AutonomousProxy-Case2.puml)

### SimulatedProxy での CurrentWeapon の初期化
#### Case1: PlayerState -> CurrentWeapon の順にレプリケーションされた場合
![CurrentWeapon-Initialize-SimulatedProxy-Case1](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/sentyaanko/GASHandsOn/main/Documents/0.1.7/CurrentWeapon-Initialize-SimulatedProxy-Case1.puml)

#### Case2: CurrentWeapon -> PlayerState の順にレプリケーションされた場合
![CurrentWeapon-Initialize-SimulatedProxy-Case2](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/sentyaanko/GASHandsOn/main/Documents/0.1.7/CurrentWeapon-Initialize-SimulatedProxy-Case2.puml)

#### CurrentWeapon の変更
![CurrentWeapon-Change](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/sentyaanko/GASHandsOn/main/Documents/0.1.7/CurrentWeapon-Change.puml)

#### CurrentWeapon の同期、 AutonomousProxy で MissPrediction した際
![CurrentWeapon-Sync-AutonomousProxy-MissPrediction](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/sentyaanko/GASHandsOn/main/Documents/0.1.7/CurrentWeapon-Sync-AutonomousProxy-MissPrediction.puml)

-----
おしまい。

